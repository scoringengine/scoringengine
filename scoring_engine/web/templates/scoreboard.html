{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container md-page">
    <div id="teamBar" style="width: 100%; min-height:400px;"></div>
    <hr>
    <div id="teamLine" style="width: 100%; height:400px;"></div>
    <script>
        // Get text color based on current theme
        function getTextColor() {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#e9ecef' : '#333';
        }

        // Bar chart for all teams
        var teamBarChart = echarts.init(document.getElementById('teamBar'));
        teamBarChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamBarChart.resize();
        });

        let serviceScoresRaw = [];  // For tooltip breakdown
        let injectScoresRaw = [];   // For tooltip breakdown
        let slaPenaltiesRaw = [];   // For tooltip breakdown
        let adjustedScores = [];    // For bar display
        let slaEnabled = false;

        $.getJSON('/api/scoreboard/get_bar_data')
            .done(function (data) {
                slaEnabled = data.sla_enabled || false;

                // Store raw values for tooltip breakdown
                serviceScoresRaw = data.service_scores.map(function(s) {
                    return parseInt(s) || 0;
                });
                injectScoresRaw = data.inject_scores.map(function(s) {
                    return parseInt(s) || 0;
                });
                if (data.sla_penalties) {
                    slaPenaltiesRaw = data.sla_penalties.map(function(p) {
                        return Math.abs(parseInt(p) || 0);
                    });
                }

                // Use adjusted scores for bar display (accounts for SLA deductions)
                adjustedScores = data.adjusted_scores.map(function(s) {
                    return { value: parseInt(s) || 0 };
                });

                // Single bar showing adjusted total
                var seriesData = [
                    {
                        name: 'Total Score',
                        data: adjustedScores,
                        type: 'bar',
                    }
                ];

                // Dynamic height: 40px per team, minimum 400px
                var chartHeight = Math.max(400, data.labels.length * 40 + 100);
                document.getElementById('teamBar').style.height = chartHeight + 'px';
                teamBarChart.resize();

                teamBarChart.hideLoading();
                teamBarChart.setOption({
                    title: {
                        text: slaEnabled ? 'Total Scores (with SLA Penalties)' : 'Total Scores',
                        x: 'center',
                        textStyle: { color: getTextColor() }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: function(params) {
                            var idx = params[0].dataIndex;
                            var result = params[0].name + '<br/>';
                            // Show breakdown from raw values
                            var services = serviceScoresRaw[idx] || 0;
                            var injects = injectScoresRaw[idx] || 0;
                            var penalty = slaPenaltiesRaw[idx] || 0;
                            var total = params[0].value || 0;

                            result += '● Services: ' + services.toLocaleString() + '<br/>';
                            result += '● Injects: ' + injects.toLocaleString() + '<br/>';
                            if (slaEnabled && penalty > 0) {
                                result += '<span style="color:#c23531">● SLA Penalties: -' + penalty.toLocaleString() + '</span><br/>';
                            }
                            result += '<strong>Total: ' + total.toLocaleString() + '</strong>';
                            return result;
                        }
                    },
                    legend: {
                        show: false
                    },
                    grid: {
                        left: '3%',
                        right: '5%',
                        bottom: '5%',
                        top: 80,
                        containLabel: true
                    },
                    yAxis: {
                        type: 'category',
                        data: data.labels,
                        axisLabel: {
                            color: getTextColor(),
                            interval: 0,
                            overflow: 'truncate',
                            width: 200
                        },
                        inverse: true
                    },
                    xAxis: {
                        type: 'value',
                        axisLabel: { color: getTextColor() }
                    },
                    series: seriesData
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamBarChart.hideLoading();
                console.error('Failed to load scoreboard data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            $.get('/api/scoreboard/get_bar_data').done(function (data) {
                slaEnabled = data.sla_enabled || false;

                // Update raw values for tooltip
                serviceScoresRaw = data.service_scores.map(function(s) {
                    return parseInt(s) || 0;
                });
                injectScoresRaw = data.inject_scores.map(function(s) {
                    return parseInt(s) || 0;
                });
                if (data.sla_penalties) {
                    slaPenaltiesRaw = data.sla_penalties.map(function(p) {
                        return Math.abs(parseInt(p) || 0);
                    });
                }

                // Update adjusted scores for bar display
                adjustedScores = data.adjusted_scores.map(function(s) {
                    return { value: parseInt(s) || 0 };
                });

                teamBarChart.setOption({
                    series: [{ data: adjustedScores }]
                });
            });
        }, 30000);
    </script>
    <script>
        // Line chart for all teams
        var teamLineChart = echarts.init(document.getElementById('teamLine'));
        teamLineChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamLineChart.resize();
        });

        const seriesList = [];
        $.getJSON('/api/scoreboard/get_line_data')
            .done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                        itemStyle: {
                            color: team.color
                        },
                        showSymbol: false
                    });
                });
                teamLineChart.hideLoading();
                teamLineChart.setOption({
                    title: {
                        text: 'Service Scores',
                        x: 'center',
                        textStyle: { color: getTextColor() }
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.rounds,
                        axisLabel: { color: getTextColor() }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: getTextColor() }
                    },
                    series: seriesList,
                    // label: {
                    //     show: true
                    // },
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamLineChart.hideLoading();
                console.error('Failed to load line chart data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            const seriesList = [];
            $.get('/api/scoreboard/get_line_data').done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                    });
                });
                teamLineChart.setOption({
                    series: seriesList,
                });
            });
        }, 30000);

        // Update chart colors when theme changes
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'data-bs-theme') {
                    var textColor = getTextColor();
                    teamBarChart.setOption({
                        title: { textStyle: { color: textColor } },
                        legend: { textStyle: { color: textColor } },
                        xAxis: { axisLabel: { color: textColor } },
                        yAxis: { axisLabel: { color: textColor } }
                    });
                    teamLineChart.setOption({
                        title: { textStyle: { color: textColor } },
                        xAxis: { axisLabel: { color: textColor } },
                        yAxis: { axisLabel: { color: textColor } }
                    });
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
    </script>
</div>
{% endblock %}