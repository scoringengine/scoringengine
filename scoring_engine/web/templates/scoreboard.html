{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container md-page">
    <div id="teamBar" style="width: 100%; height:400px;"></div>
    <hr>
    <div id="teamLine" style="width: 100%; height:400px;"></div>
    <script>
        // Bar chart for all teams
        const teamBarChart = echarts.init(document.getElementById('teamBar'));
        teamBarChart.showLoading();

        const fetchBarData = async () => {
            const response = await fetch('/api/scoreboard/get_bar_data');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        };

        const updateBarChart = async () => {
            try {
                const data = await fetchBarData();
                const serviceScores = data.service_scores.map((score) => ({ value: score }));
                const injectScores = data.inject_scores.map((score) => ({ value: score }));

                teamBarChart.hideLoading();
                teamBarChart.setOption({
                    title: {
                        text: 'Total Scores',
                        x: 'center',
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: data.labels,
                        }
                    ],
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            name: 'Services',
                            data: serviceScores,
                            type: 'bar',
                            stack: 'x',
                        },
                        {
                            name: 'Injects',
                            data: injectScores,
                            type: 'bar',
                            stack: 'x',
                        },
                    ]
                });
            } catch (error) {
                console.error('Unable to load bar chart data', error);
            }
        };

        updateBarChart();
        setInterval(updateBarChart, 30000);
    </script>
    <script>
        // Line chart for all teams
        const teamLineChart = echarts.init(document.getElementById('teamLine'));
        teamLineChart.showLoading();

        const fetchLineData = async () => {
            const response = await fetch('/api/scoreboard/get_line_data');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        };

        const updateLineChart = async () => {
            try {
                const data = await fetchLineData();
                const seriesList = data.team.map((team) => ({
                    name: team.name,
                    type: 'line',
                    data: team.scores,
                    itemStyle: { color: team.color },
                    showSymbol: false
                }));

                teamLineChart.hideLoading();
                teamLineChart.setOption({
                    title: {
                        text: 'Service Scores',
                        x: 'center',
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.rounds
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: seriesList,
                });
            } catch (error) {
                console.error('Unable to load line chart data', error);
            }
        };

        updateLineChart();
        setInterval(updateLineChart, 30000);
    </script>
</div>
{% endblock %}