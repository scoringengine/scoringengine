{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/socket.io.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container md-page">
    <div id="teamBar" style="width: 100%; height:400px;"></div>
    <hr>
    <div id="teamLine" style="width: 100%; height:400px;"></div>
    <script>
        // Bar chart for all teams
        var teamBarChart = echarts.init(document.getElementById('teamBar'));
        teamBarChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamBarChart.resize();
        });

        const serviceScores = [];
        const injectScores = [];
        // const totalScores = [];

        function updateBarChart() {
            const serviceScores = [];
            const injectScores = [];
            $.getJSON('/api/scoreboard/get_bar_data')
                .done(function (data) {
                    // Service Scores
                    echarts.util.each(data.service_scores, function (score, index) {
                        serviceScores.push({
                            value: score,
                        });
                    });
                    // Inject Scores
                    echarts.util.each(data.inject_scores, function (score, index) {
                        injectScores.push({
                            value: score,
                        });
                    });

                    var barOption = teamBarChart.getOption();
                    if (!barOption || !barOption.series) {
                        // Initial load
                        teamBarChart.hideLoading();
                        teamBarChart.setOption({
                            title: {
                                text: 'Total Scores',
                                x: 'center',
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: [
                                {
                                    type: 'category',
                                    data: data.labels,
                                }
                            ],
                            yAxis: {
                                type: 'value'
                            },
                            series: [
                                {
                                    name: 'Services',
                                    data: serviceScores,
                                    type: 'bar',
                                    stack: 'x',
                                },
                                {
                                    name: 'Injects',
                                    data: injectScores,
                                    type: 'bar',
                                    stack: 'x',
                                },
                            ]
                        });
                    } else {
                        // Update existing chart
                        teamBarChart.setOption({
                            xAxis: [{ data: data.labels }],
                            series: [
                                { data: serviceScores },
                                { data: injectScores }
                            ]
                        });
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    teamBarChart.hideLoading();
                    console.error('Failed to load scoreboard data:', textStatus, errorThrown);
                });
        }

        // Initial load
        updateBarChart();

        // Fallback polling every 5 minutes (in case WebSocket disconnects)
        setInterval(updateBarChart, 300000);
    </script>
    <script>
        // Line chart for all teams
        var teamLineChart = echarts.init(document.getElementById('teamLine'));
        teamLineChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamLineChart.resize();
        });

        function updateLineChart() {
            const seriesList = [];
            $.getJSON('/api/scoreboard/get_line_data')
                .done(function (data) {
                    echarts.util.each(data.team, function (team) {
                        seriesList.push({
                            name: team.name,
                            type: 'line',
                            data: team.scores,
                            itemStyle: {
                                color: team.color
                            },
                            showSymbol: false
                        });
                    });

                    var lineOption = teamLineChart.getOption();
                    if (!lineOption || !lineOption.series) {
                        // Initial load
                        teamLineChart.hideLoading();
                        teamLineChart.setOption({
                            title: {
                                text: 'Service Scores',
                                x: 'center',
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                boundaryGap: false,
                                data: data.rounds
                            },
                            yAxis: {
                                type: 'value'
                            },
                            series: seriesList,
                        });
                    } else {
                        // Update existing chart
                        teamLineChart.setOption({
                            xAxis: { data: data.rounds },
                            series: seriesList,
                        });
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    teamLineChart.hideLoading();
                    console.error('Failed to load line chart data:', textStatus, errorThrown);
                });
        }

        // Initial load
        updateLineChart();

        // Fallback polling every 5 minutes (in case WebSocket disconnects)
        setInterval(updateLineChart, 300000);

        // WebSocket connection for real-time updates
        const socket = io();

        socket.on('connect', function() {
            console.log('WebSocket connected');
            socket.emit('join_scoreboard');
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });

        socket.on('joined', function(data) {
            console.log('Joined room:', data.room);
        });

        socket.on('scoreboard_update', function(data) {
            console.log('Scoreboard update received for round:', data.round);
            // Update both charts when scoreboard data changes
            updateBarChart();
            updateLineChart();
        });

        socket.on('connect_error', function(error) {
            console.error('WebSocket connection error:', error);
        });
    </script>
</div>
{% endblock %}
