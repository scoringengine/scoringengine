{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container md-page">
    <div id="teamBar" style="width: 100%; height:400px;"></div>
    <hr>
    <div id="teamLine" style="width: 100%; height:400px;"></div>
    <script>
        // Bar chart for all teams
        var teamBarChart = echarts.init(document.getElementById('teamBar'));
        teamBarChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamBarChart.resize();
        });

        const serviceScores = [];
        const injectScores = [];
        const slaPenalties = [];
        let slaEnabled = false;

        $.getJSON('/api/scoreboard/get_bar_data')
            .done(function (data) {
                slaEnabled = data.sla_enabled || false;

                // Service Scores
                echarts.util.each(data.service_scores, function (score, index) {
                    serviceScores.push({
                        value: score,
                    });
                });
                // Inject Scores
                echarts.util.each(data.inject_scores, function (score, index) {
                    injectScores.push({
                        value: score,
                    });
                });
                // SLA Penalties (as negative values for visual effect)
                if (slaEnabled && data.sla_penalties) {
                    echarts.util.each(data.sla_penalties, function (penalty, index) {
                        slaPenalties.push({
                            value: -Math.abs(parseInt(penalty) || 0),
                            itemStyle: {
                                color: '#c23531'
                            }
                        });
                    });
                }

                // Build series array
                var seriesData = [
                    {
                        name: 'Services',
                        data: serviceScores,
                        type: 'bar',
                        stack: 'positive',
                    },
                    {
                        name: 'Injects',
                        data: injectScores,
                        type: 'bar',
                        stack: 'positive',
                    }
                ];

                // Add SLA penalties series when enabled
                if (slaEnabled && slaPenalties.length > 0) {
                    seriesData.push({
                        name: 'SLA Penalties',
                        data: slaPenalties,
                        type: 'bar',
                        stack: 'negative',
                        itemStyle: {
                            color: '#c23531'
                        }
                    });
                }

                teamBarChart.hideLoading();
                teamBarChart.setOption({
                    title: {
                        text: slaEnabled ? 'Total Scores (with SLA Penalties)' : 'Total Scores',
                        x: 'center',
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            var result = params[0].name + '<br/>';
                            var total = 0;
                            params.forEach(function(item) {
                                var value = Math.abs(item.value) || 0;
                                var sign = item.seriesName === 'SLA Penalties' ? '-' : '+';
                                if (item.seriesName === 'SLA Penalties') {
                                    result += item.marker + item.seriesName + ': <span style="color:#c23531">-' + value + '</span><br/>';
                                    total -= value;
                                } else {
                                    result += item.marker + item.seriesName + ': ' + value + '<br/>';
                                    total += value;
                                }
                            });
                            result += '<strong>Adjusted Total: ' + total + '</strong>';
                            return result;
                        }
                    },
                    legend: {
                        data: slaEnabled ? ['Services', 'Injects', 'SLA Penalties'] : ['Services', 'Injects'],
                        top: 30
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: data.labels,
                        }
                    ],
                    yAxis: {
                        type: 'value'
                    },
                    series: seriesData
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamBarChart.hideLoading();
                console.error('Failed to load scoreboard data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            const serviceScores = [];
            const injectScores = [];
            const slaPenalties = [];
            $.get('/api/scoreboard/get_bar_data').done(function (data) {
                const slaEnabled = data.sla_enabled || false;

                // Service Scores
                echarts.util.each(data.service_scores, function (score, index) {
                    serviceScores.push({
                        value: score,
                    });
                });
                // Inject Scores
                echarts.util.each(data.inject_scores, function (score, index) {
                    injectScores.push({
                        value: score,
                    });
                });
                // SLA Penalties
                if (slaEnabled && data.sla_penalties) {
                    echarts.util.each(data.sla_penalties, function (penalty, index) {
                        slaPenalties.push({
                            value: -Math.abs(parseInt(penalty) || 0),
                            itemStyle: {
                                color: '#c23531'
                            }
                        });
                    });
                }

                var seriesUpdate = [
                    { data: serviceScores },
                    { data: injectScores }
                ];
                if (slaEnabled && slaPenalties.length > 0) {
                    seriesUpdate.push({ data: slaPenalties });
                }

                teamBarChart.setOption({
                    title: {
                        text: slaEnabled ? 'Total Scores (with SLA Penalties)' : 'Total Scores',
                    },
                    series: seriesUpdate
                });
            });
        }, 30000);
    </script>
    <script>
        // Line chart for all teams
        var teamLineChart = echarts.init(document.getElementById('teamLine'));
        teamLineChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamLineChart.resize();
        });

        const seriesList = [];
        $.getJSON('/api/scoreboard/get_line_data')
            .done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                        itemStyle: {
                            color: team.color
                        },
                        showSymbol: false
                    });
                });
                teamLineChart.hideLoading();
                teamLineChart.setOption({
                    title: {
                        text: 'Service Scores',
                        x: 'center',
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.rounds
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: seriesList,
                    // label: {
                    //     show: true
                    // },
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamLineChart.hideLoading();
                console.error('Failed to load line chart data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            const seriesList = [];
            $.get('/api/scoreboard/get_line_data').done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                    });
                });
                teamLineChart.setOption({
                    series: seriesList,
                });
            });
        }, 30000);
    </script>

    <hr>
    <h3 class="text-center">Red Team Captures</h3>
    <div class="row mb-3">
        <div class="col-md-6 offset-md-3 text-center">
            <span class="badge bg-danger fs-6 me-2" id="redTeamTotalCaptures">0 Captures</span>
            <span class="badge bg-dark fs-6" id="redTeamTotalPoints">0.0 Points</span>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Team</th>
                    <th class="text-center">Linux User</th>
                    <th class="text-center">Linux Root</th>
                    <th class="text-center">Linux Score</th>
                    <th class="text-center">Windows User</th>
                    <th class="text-center">Windows Root</th>
                    <th class="text-center">Windows Score</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Score</th>
                </tr>
            </thead>
            <tbody id="redTeamTableBody">
                <tr>
                    <td colspan="9" class="text-center">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <p class="text-muted text-center small">
        <em>Scoring: Root capture = 1.0 point, User capture = 0.5 points (per platform)</em>
    </p>
    <script>
        function loadRedTeamData() {
            $.getJSON('/api/scoreboard/get_red_team_data')
                .done(function(data) {
                    $('#redTeamTotalCaptures').text(data.total_captures + ' Captures');
                    $('#redTeamTotalPoints').text(data.total_red_points.toFixed(1) + ' Points');

                    var tbody = $('#redTeamTableBody');
                    tbody.empty();

                    if (data.captures.length === 0) {
                        tbody.append('<tr><td colspan="9" class="text-center">No captures yet</td></tr>');
                        return;
                    }

                    // Sort by total score descending
                    data.captures.sort(function(a, b) {
                        return b.total_score - a.total_score;
                    });

                    data.captures.forEach(function(team) {
                        var row = '<tr>' +
                            '<td>' + team.team + '</td>' +
                            '<td class="text-center">' + team.nix_user + '</td>' +
                            '<td class="text-center">' + team.nix_root + '</td>' +
                            '<td class="text-center">' + team.nix_score.toFixed(1) + '</td>' +
                            '<td class="text-center">' + team.windows_user + '</td>' +
                            '<td class="text-center">' + team.windows_root + '</td>' +
                            '<td class="text-center">' + team.windows_score.toFixed(1) + '</td>' +
                            '<td class="text-center"><strong>' + team.total_captures + '</strong></td>' +
                            '<td class="text-center"><strong>' + team.total_score.toFixed(1) + '</strong></td>' +
                            '</tr>';
                        tbody.append(row);
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Failed to load red team data:', textStatus, errorThrown);
                    $('#redTeamTableBody').html('<tr><td colspan="9" class="text-center text-danger">Failed to load data</td></tr>');
                });
        }

        // Load initial data
        loadRedTeamData();

        // Update every 30 seconds
        setInterval(loadRedTeamData, 30000);
    </script>
</div>
{% endblock %}