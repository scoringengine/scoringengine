{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block content %}
<div class="container">
  <div class="row my-3">
    <div class="card">
      <div class="card-body">
        <div style="height: 400px">
          <canvas id="barScores"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="row my-3">
    <div class="card">
      <div class="card-body">
        <div style="height: 400px">
          <canvas id="lineScores"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/chart.min.js') }}"></script>
<script>
  // Bar Chart
  function updateBarChart(chart) {
    $.getJSON("/api/scoreboard/get_bar_data").done(function(response) {
      chart.data.labels = response.labels;
      if (chart.data.datasets.length == 0) {
        chart.data.datasets = [{
          label: "Services",
          data: response.service_scores
        },
        {
          label: "Injects",
          data: response.inject_scores
        }];
      } else {
        chart.data.datasets[0].data = response.service_scores; // Services
        chart.data.datasets[1].data = response.inject_scores;  // Injects
      };
      chart.update();
    });
  };

  const barChart = new Chart(document.getElementById('barScores'), {
    type: 'bar',
    options: {
      interaction: {
        mode: 'index'
      },
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Total Scores',
        }
      },
      responsive: true,
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true
        }
      },
    }
  });

  $(document).ready(function () {
    updateBarChart(barChart);
    setInterval(updateBarChart, 30000, barChart);
  });

  // Line Chart
  function updateLineChart(chart) {
    $.getJSON("/api/scoreboard/get_line_data").done(function(response) {
      chart.data.labels = response.rounds;
      if (chart.data.datasets.length == 0) {
        // Initialize the line graph
        response.team.forEach((team) => {
          chart.data.datasets.push({
            label: team.name,
            data: team.scores,
            borderColor: team.color,
            backgroundColor: team.color,
            fill: false
          });
        });
      } else {
        // Otherwise, update the data in place to prevent filters resetting
        response.team.forEach((team, index) => {
          chart.data.datasets[index].data = team.scores;
        });
      };
      chart.update();
    });
  };
  
  const lineChart = new Chart(document.getElementById('lineScores'), {
    type: 'line',
    options: {
      elements: {
        point: {
          pointStyle: false,
        }
      },
      interaction: {
        mode: 'index'
      },
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Service Scores',
        }
      },
      responsive: true,
    }
  });

  $(document).ready(function () {
    updateLineChart(lineChart);
    setInterval(updateLineChart, 30000, lineChart);
  });
</script>
{% endblock %}