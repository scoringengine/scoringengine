{% extends 'base.html' %}
{% block title %}Injects{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block content %}
<div class="container">
    <div class="row mt-3">
        <h2 class="text-center">Injects</h2>
    </div>
    <div class="row">
        <table id="injects" class="table table-striped table-bordered table-sm" style="width:100%">
            <thead>
                <tr>
                    <th>
                        <div title="ID">ID</div>
                    </th>
                    <th>
                        <div title="Title">Title</div>
                    </th>
                    <th>
                        <div title="Score">Score</div>
                    </th>
                    <th>
                        <div title="Status">Status</div>
                    </th>
                    <th>
                        <div title="Time Remaining">Time Remaining</div>
                    </th>
                </tr>
            </thead>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='vendor/js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<script>
    function formatTimer(seconds) {
        var days = Math.floor(seconds / (1000 * 60 * 60 * 24));
        var hours = Math.floor((seconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((seconds % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((seconds % (1000 * 60)) / 1000);

        return days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
    }
</script>
<script>
    $(document).ready(function () {
        // Disable datatables error reporting
        $.fn.dataTable.ext.errMode = 'none';

        var dt = $('#injects').DataTable({
            "ajax": "/api/injects",
            "columns": [
                {
                    "data": "template_id",
                    "width": "5%",
                    // "render": function (data, type, row) {
                    //     return '<a href="/inject/' + data + '">' + data + '</a>';
                    // }
                },
                {
                    "data": "title",
                    "width": "60%",
                    "render": function (data, type, row) {
                        return '<a href="/inject/' + row['id'] + '">' + data + '</a>';
                    }

                },
                {
                    "data": "score",
                    "width": "10%",
                    "render": function (data, type, row) {
                        return data + " (" + (100 * data) / row['max_score'] + "%)";
                    }
                },
                {
                    "data": "status",
                    "width": "5%",
                    "render": function (data, type, row) {
                        if (data == "Draft") {
                            var currentTime = new Date();
                            var endTime = new Date(row['end_time']);

                            if (currentTime > endTime) {
                                return '<span class="badge bg-danger">Expired</span>';
                            } else {
                                return '<span class="badge bg-warning">' + data + '</span>';
                            }
                        } else if (data == "Submitted") {
                            return '<span class="badge bg-success">' + data + '</span>';
                        } else if (data == "Graded") {
                            return '<span class="badge bg-info">' + data + '</span>';
                        } else {
                            return '<span class="badge bg-danger">' + data + '</span>';
                        }
                    }
                },
                // {
                //     "data": "graded",
                //     "width": "5%",
                //     "render": function (data, type, row) {
                //         if (data == "Submitted") {
                //             return '<span class="label label-success">' + data + '</span>';
                //         } else if (data == "Pending") {
                //             return '<span class="label label-warning">' + data + '</span>';
                //         } else {
                //             return '<span class="label label-danger">Not Submitted</span>';
                //         }
                //     }
                // },
                {
                    "data": "end_time",
                    "width": "15%",
                    "render": function (data, type, row) {
                        var currentTime = new Date();
                        var endTime = new Date(data);

                        if (endTime > currentTime) {
                            return formatTimer(endTime - currentTime);
                        } else {
                            return formatTimer(0)
                        }
                    }
                },
            ],
            'paging': false,
            // 'bFilter': false,
            'bInfo': false,
            "order": [
                [0, 'asc']
            ],
            'ordering': false,
        });
    });
</script>
{% endblock %}