{% extends 'base.html' %}
{% block title %}Stats{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block content %}
<div class="page-wrap">
    <h3 class="section-header">Active Flags</h3>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="flags" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Type</th>
                    <th>Platform</th>
                    <th>Permission</th>
                    <th>Path</th>
                    <th>Content</th>
                </tr>
            </thead>
        </table>
    </div>

    <h3 class="section-header">Capture Status for Active Flags</h3>
    <p class="text-muted"><i class='bi bi-dash-lg' style='color: gray'></i> means no capture; <i class='bi bi-person-fill' style='color: blue'></i> means user level capture; and <i class='bi bi-fire' style='color: red'></i> means root level capture</p>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="solves" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                </tr>
            </thead>
        </table>
    </div>

    <h3 class="section-header">Competition Flag Capture Stats</h3>
    <p class="text-muted">A lower score means the team is doing better</p>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="totals" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Team</th>
                    <th>Windows Score</th>
                    <th>nix Score</th>
                    <th>Total Score</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<script>
$(document).ready(function() {
  $('#flags').DataTable( {
      ajax: '/api/flags',
      order: [[1, 'asc']],
      columns: [
        { data: 'id' },
        { data: 'start_time' },
        { data: 'end_time' },
        { data: 'type' },
        { data: 'platform' },
        { data: 'perm' },
        { data: 'path' },
        { data: 'content' }
      ],
  } );

  // Solves table
    $.ajax({
        url: '/api/flags/solves',  // API endpoint to fetch data
        success: function(response) {
            $('#solves').DataTable({
                data: response.data.rows, 
		scrollX: true,
                columns: response.data.columns.map(col => ({
		    title: col.replace("_BTA ", ""),
		    render: function (data, type, row) {
			// Render fire for true pwn, gray minus for false/no pwn
			if(typeof data === "string") {
			    return data;
			} else if (Array.isArray(data)) {
			    if(data[1] == 1) {
			        return "<i class='bi bi-fire' style='color: red'></i>";
			    } else if(data[0] == 1) {
			        return "<i class='bi bi-person-fill' style='color: blue'></i>";
		            } else {
			        return "<i class='bi bi-dash-lg' style='color: gray'></i>";
			    }
			}
                    }
		})), 
                ordering: false,  // Disable ordering on all columns
            });
        },
        error: function(xhr, status, error) {
            console.error('Error fetching data:', error);
        }
    });

  // Totals table
  $('#totals').DataTable( {
      ajax: '/api/flags/totals',
      order: [[1, 'asc']],
      columns: [
        { data: 'team' },
        { data: 'win_score' },
        { data: 'nix_score' },
        { data: 'total_score' }
      ],
  } );
});
</script>
{% endblock %}
