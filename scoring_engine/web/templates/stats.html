{% extends 'base.html' %}
{% block title %}Stats{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block content %}
<div class="page-wrap">
    <h3 class="section-header">All-Time Service Statistics</h3>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="service-summary" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Up</th>
                    <th>Down</th>
                    <th>Total</th>
                    <th>Uptime %</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <h3 class="section-header">Round Stats</h3>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="stats" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Duration</th>
                    <th>Service Ratio</th>
                    <th>Failures by Service</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
    function formatDuration(seconds) {
        if (seconds < 60) {
            return seconds + 's';
        } else if (seconds < 3600) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return mins + 'm ' + secs + 's';
        } else {
            var hours = Math.floor(seconds / 3600);
            var mins = Math.floor((seconds % 3600) / 60);
            var secs = seconds % 60;
            return hours + 'h ' + mins + 'm ' + secs + 's';
        }
    }

    $.ajax({
        url: '/api/stats',
        dataType: 'json',
        success: function(response) {
            // Populate all-time summary table
            var summaryRows = [];
            var summary = response.summary || {};
            $.each(summary, function(serviceName, counts) {
                var pct = counts.total > 0 ? ((counts.up / counts.total) * 100).toFixed(1) : '0.0';
                summaryRows.push([serviceName, counts.up, counts.down, counts.total, pct + '%']);
            });
            $('#service-summary').DataTable({
                data: summaryRows,
                paging: false,
                searching: false,
                order: [[0, 'asc']]
            });

            // Populate per-round stats table
            var roundRows = [];
            var data = response.data || [];
            $.each(data, function(i, row) {
                var ratio = row.num_up_services + ' <i class="bi bi-chevron-up text-success" aria-hidden="true"></i> / ' + row.num_down_services + ' <i class="bi bi-chevron-down text-danger" aria-hidden="true"></i>';

                var failures = [];
                var breakdown = row.service_breakdown || {};
                $.each(breakdown, function(svc, counts) {
                    if (counts.down > 0) {
                        failures.push('<span class="text-danger">' + svc + ' x' + counts.down + '</span>');
                    }
                });
                var failureText = failures.length > 0 ? failures.join(', ') : '<span class="text-success">All passing</span>';

                roundRows.push([row.round_id, row.start_time, row.end_time, formatDuration(row.total_seconds), ratio, failureText]);
            });
            $('#stats').DataTable({
                data: roundRows,
                order: [[0, 'desc']]
            });
        }
    });
</script>
{% endblock %}
