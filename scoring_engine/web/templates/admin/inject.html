{% extends 'admin/adminbase.html' %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />

<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}

{% block header %}
{% if inject.status == 'Submitted' %}
<p>{{ inject.team.name }} - {{ inject.template.title }} <span class="badge bg-success">{{ inject.status}}</span>
</p>
{% elif inject.status == 'Graded' %}
<p>{{ inject.team.name }} - {{ inject.template.title }} <span class="badge bg-info text-dark">{{ inject.status}}</span></p>
{% elif inject.template.expired %}
<p>{{ inject.team.name }} - {{ inject.template.title }} <span class="badge bg-danger">Expired</span></p>
{% elif inject.status == 'Draft' %}
<p>{{ inject.team.name }} - {{ inject.template.title }} <span class="badge bg-warning text-dark">{{ inject.status}}</span>
</p>
{% else %}
<p>{{ inject.template.title }}</p>
{% endif %}
{% endblock %}

{% block admincontent %}

{% if inject.status == 'Submitted' %}
<div class="card mb-3">
  <div class="card-body">
    <form class="row row-cols-lg-auto g-3 align-items-center">
      <div class="col-12">
        <label for="inputGrade" class="col-form-label">Grade</label>
      </div>
      <div class="col-12">
        <input type="number" class="form-control" id="inputGrade" placeholder="100">
      </div>
      <div class="col-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitGradeConfirmation">Submit
          Grade</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% if inject.template.rubric %}
<h4>Rubric</h4>
<table class="table table-bordered">
  <tr>
    <th>Deliverable</th>
    <th>Value</th>
  </tr>
  {% for rubric in inject.template.rubric %}
  <tr>
    <td>{{ rubric.deliverable }}</td>
    <td>{{ rubric.value }}</td>
  </tr>
  {% endfor %}
</table>
{% endif %}
<h4>Grade</h4>
<p>{{ inject.score }}</p>
<h4>Files</h4>
<div id="files"></div>
<h4>Comments</h4>
<div id="comments"></div>
<div class="card">
  <div class="card-body">
    <form>
      <div class="mb-3">
        <textarea id="commentArea" class="form-control" rows="3"></textarea>
      </div>
      <div class="mb-3">
        <button id="addCommentButton" type="button" class="btn btn-primary">Comment</button>
      </div>
    </form>
  </div>
</div>
<!-- Submit Modal -->
<div class="modal fade" id="submitGradeConfirmation" tabindex="-1" aria-labelledby="submitGradeConfirmationLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submit Grade</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="injectId" id="injectId" value="{{ inject.id }}" />
        <p>Are you sure you want to submit a grade for this inject?</p>
        <p><b>You will not be able to edit this inject after submitting.</b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="gradeSubmitConfirmButton" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function () {
    // Load comments and update every 30 seconds
    updateComments();
    setInterval(updateComments, 30000);

    // Load files and update every 30 seconds
    updateFiles();
    setInterval(updateFiles, 30000);
  });
</script>
<script>
  function updateFiles() {
    // Query API for files
    $.ajax({
      url: "/api/inject/{{ inject.id }}/files",
      success: function (result) {
        var files = '';

        // Append new files
        $.each(result.data, function (index, value) {
          files += "<p><a href='/api/inject/{{ inject.id }}/files/" + value.id + "/download'>" + value.name + "</a></p>";
        });

        // Update navbar
        $("#files").html(files);
      },
      error: function (result) {
        console.error("An Error Occurred Querying For Files");
      }
    });
  };
</script>
<script>
  function updateComments() {
    // Query API for files
    $.ajax({
      url: "/api/inject/{{ inject.id }}/comments",
      success: function (result) {
        var comments = ""

        // Append comment elements
        $.each(result.data, function (index, value) {
          if (value.team == "{{ current_user.team.name }}") {
            comments += '<div class="card border-primary mb-2">' +
              '<div class="card-header bg-primary text-white">' + value.user + ' (' + value.team + ') commented on ' + value.added + '</div>' +
              '<div class="card-body">' + value.text + '</div></div>';
          } else {
            comments += '<div class="card mb-2">' +
              '<div class="card-header">' + value.user + ' (' + value.team + ') commented on ' + value.added + '</div>' +
              '<div class="card-body">' + value.text + '</div></div>';
          }
        });

        // Update comments
        $("#comments").html(comments);
      },
      error: function (result) {
        console.error("An Error Occurred Querying For Files");
      }
    });
  };
</script>
<script>
  $('#addCommentButton').unbind().click(function () {
    $.ajax({
      url: "/api/inject/{{ inject.id }}/comment",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        comment: $('#commentArea').val()
      }),
      success: function (result) {
        console.log("Comment added");
        $('#commentArea').val('');
        updateComments();
      },
      error: function (result) {
        alert(result.responseJSON['status']);
        console.error("ERROR:", result.responseJSON['status']);
      }
    });
  });
</script>
<script>
  // Submit Grade Confirmation
  $('#gradeSubmitConfirmButton').unbind().click(function () {
    const injectId = $('#injectId').val();
    $.ajax({
      url: "/api/admin/inject/" + injectId + "/grade",
      type: 'POST',
      contentType: "application/json",
      data: JSON.stringify({
        score: $('#inputGrade').val()
      }),
      success: function (result) {
        bootstrap.Modal.getInstance(document.getElementById('submitGradeConfirmation')).hide();
        location.reload();  // Reload page
      },
      error: function (result) {
        console.error("ERROR:", result.responseJSON['status']);
      }
    });
  });
</script>
{% endblock %}
