{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Round Stats{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/utils.js') }}"></script>
{% endblock %}

{% block header %}
Round Stats
{% endblock %}

{% block admincontent %}
<div class="row mb-4 pt-3">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-people-fill"></i> Blue Teams</h6>
        <h3 id="comp_blue_teams" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-hdd-network-fill"></i> Total Services</h6>
        <h3 id="comp_total_services" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-check-circle-fill"></i> Currently Passing</h6>
        <h3 id="comp_currently_passing" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-graph-up"></i> Overall Uptime</h6>
        <h3 id="comp_overall_uptime" class="mb-0">-</h3>
      </div>
    </div>
  </div>
</div>
<script>
  function getCompetitionSummary() {
    $.ajax({
      cache: false,
      url: '/api/admin/get_competition_summary',
      dataType: 'json',
      success: function (data) {
        $('#comp_blue_teams').text(data.blue_teams);
        $('#comp_total_services').text(data.total_services);
        $('#comp_currently_passing').text(data.currently_passing);
        $('#comp_overall_uptime').text(data.overall_uptime + '%');
      }
    });
  }

  $(document).ready(function () {
    getCompetitionSummary();
    setInterval(function () {
      getCompetitionSummary()
    }, 5000);
  });
</script>
<h5 class="mb-3">Engine Stats</h5>
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-arrow-repeat"></i> Round</h6>
        <h3 id="round_number" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-check-lg text-success"></i> Passed Checks</h6>
        <h3 id="num_passed_checks" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-x-lg text-danger"></i> Failed Checks</h6>
        <h3 id="num_failed_checks" class="mb-0">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h6 class="card-title text-muted"><i class="bi bi-list-ol"></i> Total Checks</h6>
        <h3 id="total_checks" class="mb-0">-</h3>
      </div>
    </div>
  </div>
</div>
<script>
  function getEngineStats() {
    $.ajax({
      cache: false,
      url: '/api/admin/get_engine_stats',
      dataType: 'json',
      success: function (data) {
        $('#round_number').text(data.round_number);
        $('#num_passed_checks').text(data.num_passed_checks);
        $('#num_failed_checks').text(data.num_failed_checks);
        $('#total_checks').text(data.total_checks);
      }
    });
  }

  $(document).ready(function () {
    getEngineStats();
    setInterval(function () {
      getEngineStats()
    }, 5000);
  });
</script>
<div class="round_status_bars">
  <h4>Current Round Status</h4>
  <span>Round Progress</span>
  <div class="progress">
    <div id="TotalPercent" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0"
      aria-valuemin="0" aria-valuemax="100" style="width:0%">
      <span>0%</span>
    </div>
  </div>
  {% for team in blue_teams %}
  <span>{{team.name}}</span>
  <div class="progress">
    <div id="{{team.name}}Percent" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
      role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
      <span>0%</span>
    </div>
  </div>
  {% endfor %}
</div>
</div>
<script>
  function getProgress() {
    $.getJSON('/api/admin/get_round_progress', function (data) {
      $.each(data, function (key, val) {
        // Sanitize key before using in selector to prevent XSS
        var sanitizedKey = ScoringEngineUtils.sanitizeSelector(key);
        var $progressBar = $("#" + sanitizedKey + "Percent");
        var $progressSpan = $progressBar.find('span');

        // Update progress bar
        $progressBar.css('width', val + "%").attr('aria-valuenow', val);
        $progressSpan.text(val + "%");

        // Update progress bar class based on completion
        if (val < 100) {
          $progressBar.attr('class', 'progress-bar progress-bar-striped progress-bar-animated bg-warning');
        } else {
          $progressBar.attr('class', 'progress-bar progress-bar-striped progress-bar-animated bg-success');
        }
      });
    });
  }

  $(document).ready(function () {
    getProgress()
  });
  setInterval(getProgress, 3000);
</script>
{% endblock %}