{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Round Stats{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/utils.js') }}"></script>
{% endblock %}

{% block header %}
Round Stats
{% endblock %}

{% block admincontent %}
<div class="stat-cards-row pt-2">
  <div class="stat-card">
    <div class="stat-label">Blue Teams</div>
    <div class="stat-value" id="comp_blue_teams">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Services</div>
    <div class="stat-value" id="comp_total_services">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Currently Passing</div>
    <div class="stat-value text-success" id="comp_currently_passing">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Overall Uptime</div>
    <div class="stat-value" id="comp_overall_uptime">-</div>
  </div>
</div>
<script>
  function getCompetitionSummary() {
    $.ajax({
      cache: false,
      url: '/api/admin/get_competition_summary',
      dataType: 'json',
      success: function (data) {
        $('#comp_blue_teams').text(data.blue_teams);
        $('#comp_total_services').text(data.total_services);
        $('#comp_currently_passing').text(data.currently_passing);
        $('#comp_overall_uptime').text(data.overall_uptime + '%');
      }
    });
  }

  $(document).ready(function () {
    getCompetitionSummary();
    setInterval(function () {
      getCompetitionSummary()
    }, 5000);
  });
</script>
<h3 class="section-header">Engine Stats</h3>
<div class="stat-cards-row">
  <div class="stat-card">
    <div class="stat-label">Round</div>
    <div class="stat-value" id="round_number">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Passed Checks</div>
    <div class="stat-value text-success" id="num_passed_checks">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Failed Checks</div>
    <div class="stat-value text-danger" id="num_failed_checks">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Checks</div>
    <div class="stat-value" id="total_checks">-</div>
  </div>
</div>
<script>
  function getEngineStats() {
    $.ajax({
      cache: false,
      url: '/api/admin/get_engine_stats',
      dataType: 'json',
      success: function (data) {
        $('#round_number').text(data.round_number);
        $('#num_passed_checks').text(data.num_passed_checks);
        $('#num_failed_checks').text(data.num_failed_checks);
        $('#total_checks').text(data.total_checks);
      }
    });
  }

  $(document).ready(function () {
    getEngineStats();
    setInterval(function () {
      getEngineStats()
    }, 5000);
  });
</script>
<h3 class="section-header">Current Round Status</h3>
<div class="chart-card">
  <div class="mb-3">
    <div class="d-flex justify-content-between mb-1">
      <small class="text-muted">Round Progress</small>
      <small id="TotalPercentLabel" class="text-muted">0%</small>
    </div>
    <div class="progress">
      <div id="TotalPercent" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0"
        aria-valuemin="0" aria-valuemax="100" style="width:0%">
      </div>
    </div>
  </div>
  {% for team in blue_teams %}
  <div class="mb-3">
    <div class="d-flex justify-content-between mb-1">
      <small class="text-muted">{{team.name}}</small>
      <small id="{{team.name}}PercentLabel" class="text-muted">0%</small>
    </div>
    <div class="progress">
      <div id="{{team.name}}Percent" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
      </div>
    </div>
  </div>
  {% endfor %}
</div>
<script>
  function getProgress() {
    $.getJSON('/api/admin/get_round_progress', function (data) {
      $.each(data, function (key, val) {
        // Sanitize key before using in selector to prevent XSS
        var sanitizedKey = ScoringEngineUtils.sanitizeSelector(key);
        var $progressBar = $("#" + sanitizedKey + "Percent");
        var $label = $("#" + sanitizedKey + "PercentLabel");

        // Update progress bar
        $progressBar.css('width', val + "%").attr('aria-valuenow', val);
        $label.text(val + "%");

        // Update progress bar class based on completion
        if (val < 100) {
          $progressBar.attr('class', 'progress-bar progress-bar-striped progress-bar-animated bg-warning');
        } else {
          $progressBar.attr('class', 'progress-bar progress-bar-striped progress-bar-animated bg-success');
        }
      });
    });
  }

  $(document).ready(function () {
    getProgress()
  });
  setInterval(getProgress, 3000);
</script>
{% endblock %}