{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Manage Teams{% endblock %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block header %}Users{% endblock %}
{% block admincontent %}

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title text-center">Update Password</h5>
          <form method="POST" action="{{ url_for('api.admin_update_password') }}" role="form">
            <div class="mb-3">
              <select class="form-select" name="user_id" id="userSelect">
                {% for user in users %}
                <option value="{{ user[0] }}">{{ user[1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" name="password" id="inputPassword" placeholder="Password" required autofocus>
            </div>
            <button type="submit" class="btn btn-primary d-block mx-auto">Update Password</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title text-center">Add User</h5>
          <form method="POST" action="{{ url_for('api.admin_add_user') }}" role="form">
            <div class="mb-3">
              <input type="text" class="form-control" name="username" id="userUsername" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" name="password" id="userPassword" placeholder="Password" required>
            </div>
            <div class="mb-3">
              <select class="form-select" name="team_id" id="team_id">
                {% for team in teams %}
                <option value="{{ team[0] }}">{{ team[1] }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-primary d-block mx-auto">Add User</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title text-center">Add Team</h5>
          <form method="POST" action="{{ url_for('api.admin_add_team') }}" role="form">
            <div class="mb-3">
              <input type="text" class="form-control" name="name" id="team" placeholder="Team Name" required>
            </div>
            <div class="mb-3">
              <select class="form-select" name="color" id="teamSelect">
                <option value="Red">Red</option>
                <option value="White">White</option>
                <option value="Blue">Blue</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary d-block mx-auto">Add Team</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <h3 class="section-header">Teams</h3>
  <div class="chart-card" style="padding:0; overflow:hidden;">
    <table id="users" class="table table-sm overview-matrix" width="100%">
      <thead>
        <tr>
          <th></th>
          <th>Team Name</th>
          <th>Color</th>
        </tr>
      </thead>
    </table>
  </div>
  <script>
    /* Formatting function for row details - modify as you need */
    function format (data) {
      var rows = [
        '<table id="users" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">',
        '<tr>',
        '<th>Username</th>',
        '<th>Password</th>',
        '<th>Logged In</th>',
        '</tr><tbody>'
      ];

      for (var key in data.users) {
        rows.push('<tr><td>' + key + '</td><td>' + data.users[key][0] + '</td><td>' + data.users[key][1] + '</td></tr>');
      }

      rows.push('</tbody></table>');
      return rows.join('');
    }

    $(document).ready(function() {
      // Disable datatables error reporting
      $.fn.dataTable.ext.errMode = 'none';

      var table = $('#users')
        .on('error.dt', function (e, settings, techNote, message) {
          console.log('An error has been reported by DataTables: ', message);
        })
        .DataTable( {
          "ajax": {
            "url": "/api/admin/get_teams",
            "type": 'GET'
          },
          "columns": [
            {
              "className": 'details-control',
              "orderable": false,
              "data": null,
              "defaultContent": ''
            },
            { "data": "name" },
            { "data": "color" }
          ],
          'order': [[2, 'asc']],
          'paging': false,
          'bFilter': false,
          'bInfo': false
        });

      // Add event listener for opening and closing details
      $('#users tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row( tr );

        if ( row.child.isShown() ) {
          // This row is already open - close it
          row.child.hide();
          tr.removeClass('shown');
        }
        else {
          // Open this row
          row.child( format(row.data()) ).show();
          tr.addClass('shown');
        }
      });
    });
  </script>
{% endblock %}
