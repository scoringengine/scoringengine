{% extends 'admin/adminbase.html' %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}

{% block header %}Inject Scores{% endblock %}

{% block admincontent %}
<h3 class="section-header" style="margin-top:1rem;">Inject Scores</h3>
<div class="chart-card">
  <div id="teamBar" style="width: 100%; height:300px;"></div>
</div>
<h3 class="section-header">Blue Team Injects</h3>
<div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="injects" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th>Inject Name</th>
        <th>Time Left</th>
        {% for team in blue_teams %}
        <th>{{ team.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<h3 class="section-header">Red Team Injects</h3>
<div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="redTeamInjects" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th>Inject Name</th>
        <th>Time Left</th>
        {% for team in blue_teams %}
        <th>{{ team.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<script>
  function formatTimer(seconds) {
    var days = Math.floor(seconds / (1000 * 60 * 60 * 24));
    var hours = Math.floor((seconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((seconds % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((seconds % (1000 * 60)) / 1000);

    return days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
  }
</script>
<script>
  $(document).ready(function () {
    // Disable datatables error reporting
    $.fn.dataTable.ext.errMode = 'none';

    var dt = $('#injects').DataTable({
      "ajax": '/api/admin/injects/scores',
      "lengthChange": false,
      "ordering": false,
      "paging": false,
      "scrollX": true,
      "searching": false,
      "info": false,
      "columns": [
        { "data": "title" },
        {
          "data": "end_time",
          "width": "20%",
          "render": function (data, type, row) {
            var currentTime = new Date();
            var endTime = new Date(data);

            if (endTime > currentTime) {
              return formatTimer(endTime - currentTime);
            } else {
              return "Expired";
            }
          }
        },
        {% for team in blue_teams %}
        {
        "data": "{{ team.name }}",
        "render": function (data, type, row, meta) {
          if (data == null) {
            return "Not Submitted";
          } else if (data['status'] == 'Graded') {
            return data['score'] + " (" + (100 * data['score']) / data['max_score'] + "%)";
          } else if (data['status'] == 'Submitted') {
            // TODO - Add modal for grading / commenting
            return "<a href=/admin/injects/" + data['id'] + ">Grade Me!</a>";
          } else {
            return "Not Submitted";
          }
        },
      },
      {% endfor %}
      ],
    });

  // Bar chart for all teams
  var isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
  var teamBarChart = echarts.init(document.getElementById('teamBar'), isDark ? 'dark' : null);
  teamBarChart.showLoading();

  const injectScores = [];

  $.getJSON('/api/admin/injects/get_bar_chart').done(function (data) {
    // Blue Team Inject Scores
    echarts.util.each(data.inject_scores, function (score, index) {
      injectScores.push({
        value: score,
      });
    });
    teamBarChart.hideLoading();
    teamBarChart.setOption({
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
      },
      yAxis: [
        {
          type: 'value'
        }
      ],
      xAxis: [
        {
          type: 'category',
          axisLabel: {
            interval: 0,
            rotate: 90
          },
          axisTick: {
            show: false
          },
          data: data.labels,
        }
      ],
      series: [
        {
          name: 'Blue Team Injects',
          type: 'bar',
          stack: 'Total',
          label: {
            show: true
          },
          data: injectScores,
        },
        {
          name: 'Red Team Injects',
          type: 'bar',
          stack: 'Total',
          label: {
            show: true,
          },
          // data: [-320, -232, -301, -234, -290]
          data: []
        }
      ]
    });
  });
  });
</script>
{% endblock %}