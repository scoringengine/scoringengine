{% extends 'admin/adminbase.html' %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}

{% block header %}Inject Scores{% endblock %}

{% block admincontent %}
<!-- Summary Stats -->
<div class="stat-cards-row mb-3" style="margin-top:1rem;">
  <div class="stat-card">
    <div class="stat-label">Needs Grading</div>
    <div class="stat-value text-warning" id="stat-needs-grading">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Graded</div>
    <div class="stat-value text-success" id="stat-graded">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Revision Requested</div>
    <div class="stat-value" id="stat-revision" style="color:var(--accent-amber);">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Not Submitted</div>
    <div class="stat-value" id="stat-not-submitted" style="color:var(--text-tertiary);">-</div>
  </div>
</div>

<h3 class="section-header">Inject Scores</h3>
<div class="chart-card">
  <div id="teamBar" style="width: 100%; height:300px;"></div>
</div>
<h3 class="section-header">Blue Team Injects</h3>
<div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="injects" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th>Inject Name</th>
        <th>Time Left</th>
        {% for team in blue_teams %}
        <th>{{ team.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<h3 class="section-header">Red Team Injects</h3>
<div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="redTeamInjects" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th>Inject Name</th>
        <th>Time Left</th>
        {% for team in blue_teams %}
        <th>{{ team.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
<script>
  function formatTimer(seconds) {
    var days = Math.floor(seconds / (1000 * 60 * 60 * 24));
    var hours = Math.floor((seconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((seconds % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((seconds % (1000 * 60)) / 1000);

    return days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
  }
</script>
<script>
  $(document).ready(function () {
    // Disable datatables error reporting
    $.fn.dataTable.ext.errMode = 'none';

    var dt = $('#injects').DataTable({
      "ajax": '/api/admin/injects/scores',
      "lengthChange": false,
      "ordering": false,
      "paging": false,
      "scrollX": true,
      "searching": false,
      "info": false,
      "columns": [
        { "data": "title" },
        {
          "data": "end_time",
          "width": "20%",
          "render": function (data, type, row) {
            var currentTime = new Date();
            var endTime = new Date(data);

            if (endTime > currentTime) {
              return formatTimer(endTime - currentTime);
            } else {
              return "Expired";
            }
          }
        },
        {% for team in blue_teams %}
        {
        "data": "{{ team.name }}",
        "render": function (data, type, row, meta) {
          if (data == null) {
            return '<span class="badge bg-secondary">Not Submitted</span>';
          } else if (data['status'] == 'Graded') {
            return '<a href="/admin/injects/' + data['id'] + '"><span class="badge bg-success">' + data['score'] + ' (' + (100 * data['score'] / data['max_score']).toFixed(2) + '%)</span></a>';
          } else if (data['status'] == 'Submitted' || data['status'] == 'Resubmitted') {
            return '<a href="/admin/injects/' + data['id'] + '"><span class="badge bg-warning text-dark">Grade Me!</span></a>';
          } else if (data['status'] == 'Revision Requested') {
            return '<a href="/admin/injects/' + data['id'] + '"><span class="badge bg-info text-white">Revision Req.</span></a>';
          } else if (data['status'] == 'Draft') {
            return '<span class="badge bg-secondary">Draft</span>';
          } else {
            return '<span class="badge bg-secondary">' + (data['status'] || 'Not Submitted') + '</span>';
          }
        },
      },
      {% endfor %}
      ],
      "initComplete": function () {
        // Compute summary stats from the loaded data
        var tableData = dt.data();
        var needsGrading = 0, graded = 0, revision = 0, notSubmitted = 0;
        var teamNames = [{% for team in blue_teams %}"{{ team.name }}",{% endfor %}];
        tableData.each(function (row) {
          teamNames.forEach(function (team) {
            var cell = row[team];
            if (cell == null || cell['status'] == null) {
              notSubmitted++;
            } else if (cell['status'] == 'Submitted' || cell['status'] == 'Resubmitted') {
              needsGrading++;
            } else if (cell['status'] == 'Graded') {
              graded++;
            } else if (cell['status'] == 'Revision Requested') {
              revision++;
            } else {
              notSubmitted++;
            }
          });
        });
        $('#stat-needs-grading').text(needsGrading);
        $('#stat-graded').text(graded);
        $('#stat-revision').text(revision);
        $('#stat-not-submitted').text(notSubmitted);
      }
    });

  // Bar chart for all teams
  var isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
  var teamBarChart = echarts.init(document.getElementById('teamBar'), isDark ? 'dark' : null);
  teamBarChart.showLoading();

  const injectScores = [];

  $.getJSON('/api/admin/injects/get_bar_chart').done(function (data) {
    // Blue Team Inject Scores
    echarts.util.each(data.inject_scores, function (score, index) {
      injectScores.push({
        value: score,
      });
    });
    teamBarChart.hideLoading();
    teamBarChart.setOption({
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
      },
      yAxis: [
        {
          type: 'value'
        }
      ],
      xAxis: [
        {
          type: 'category',
          axisLabel: {
            interval: 0,
            rotate: 90
          },
          axisTick: {
            show: false
          },
          data: data.labels,
        }
      ],
      series: [
        {
          name: 'Blue Team Injects',
          type: 'bar',
          stack: 'Total',
          label: {
            show: true
          },
          data: injectScores,
        },
        {
          name: 'Red Team Injects',
          type: 'bar',
          stack: 'Total',
          label: {
            show: true,
          },
          // data: [-320, -232, -301, -234, -290]
          data: []
        }
      ]
    });
  });
  });
</script>
{% endblock %}