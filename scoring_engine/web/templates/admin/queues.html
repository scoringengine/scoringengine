{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Queue Stats{% endblock %}

{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
    <link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />
{% endblock %}
{% block header %}Queue Stats{% endblock %}

{% block admincontent %}
  <div class="stat-cards-row pt-2">
    <div class="stat-card">
      <div class="stat-label">Total Queues</div>
      <div class="stat-value" id="summary_total_queues">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Workers Assigned</div>
      <div class="stat-value" id="summary_total_workers">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Running Tasks</div>
      <div class="stat-value text-success" id="summary_running_tasks">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Scheduled Tasks</div>
      <div class="stat-value" id="summary_scheduled_tasks">-</div>
    </div>
  </div>
  <div class="d-flex justify-content-end mt-2 mb-2">
    <small class="text-muted">Last updated: <span id="last_updated">-</span></small>
  </div>
  <div class="chart-card mt-1" style="padding:0; overflow:hidden;">
    <table id="queues" class="table table-sm overview-matrix" width="100%">
      <thead>
        <tr>
          <th><div title="Name of Queue">Worker Queue Name</div></th>
          <th><div title="List of the workers that are assigned to run checks for this service">Workers Assigned</div></th>
          <th><div title="Currently running tasks in this queue">Running Tasks</div></th>
          <th><div title="Tasks scheduled for future execution">Scheduled Tasks</div></th>
          <th><div title="List of the services that are associated with this worker queue name">Services Associated</div></th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <script>
    function updateLastUpdated() {
      var now = new Date();
      var timeStr = now.toLocaleTimeString();
      $('#last_updated').text(timeStr);
    }

    function updateQueueSummary(data) {
      var totalQueues = data.length;
      var totalWorkers = 0;
      var totalRunning = 0;
      var totalScheduled = 0;
      for (var i = 0; i < data.length; i++) {
        totalWorkers += data[i].worker_count || 0;
        totalRunning += data[i].running_tasks || 0;
        totalScheduled += data[i].scheduled_tasks || 0;
      }
      $('#summary_total_queues').text(totalQueues);
      $('#summary_total_workers').text(totalWorkers);
      $('#summary_running_tasks').text(totalRunning);
      $('#summary_scheduled_tasks').text(totalScheduled);
    }

    $(document).ready(function() {
      // Disable datatables error reporting
      $.fn.dataTable.ext.errMode = 'none';

      var table = $('#queues')
        .on('error.dt', function (e, settings, techNote, message) {
          console.log('An error has been reported by DataTables: ', message);
        })
        .DataTable({
          'paging': false,
          'bFilter': false,
          'bInfo': false,
          "ajax": {
            "url": "/api/admin/get_queue_stats",
            "dataSrc": function(json) {
              updateLastUpdated();
              updateQueueSummary(json.data);
              return json.data;
            }
          },
          "language": {
            "emptyTable": "No queues are currently configured",
          },
          "columns": [
            { "data": "name" },
            {
              "data": "workers",
              "render": function( data ) {
                var text = "";
                if (data.length == 0) {
                  text = 'None <span class="bi bi-exclamation-triangle-fill" style="color:red" title="No workers are setup to run service checks from this queue. This will prevent the engine from working correctly."></span>';
                }
                else {
                  for (var key in data) {
                     text += "" + data[key] + "<br>";
                  }
                }
                return text;
              }
            },
            { "data": "running_tasks" },
            { "data": "scheduled_tasks" },
            {
              "width": 170,
              "data": "services_running",
              "render": function( data ) {
                var text = "";
                if (typeof data === 'string'){
                  text = data;
                }
                else {
                  for (var key in data) {
                    text += "" + key;
                    if (typeof data[key] === 'string') {
                      text += " - " + data[key];
                    }
                    else {
                      text += " - " + data[key].join(', ');
                    }
                    text += "<br>";
                  }
                }
                return text;
              }
            },
          ],
        });
      setInterval( function () {
        table.ajax.reload(null, false);
      }, 10000 );
    } );
  </script>
{% endblock %}
