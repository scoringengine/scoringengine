{% extends 'admin/adminbase.html' %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />

<!-- YAML Export -->
<script src="{{ url_for('static', filename='vendor/js/js-yaml.min.js') }}"></script>

<!-- Moment -->
<script src="{{ url_for('static', filename='vendor/js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/moment-timezone.min.js') }}"></script>
{% endblock %}

{% block header %}Inject Templates{% endblock %}

{% block admincontent %}
<div class="d-flex justify-content-between align-items-center mb-3" style="margin-top:1rem;">
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTemplateModal">
    <i class="bi bi-plus-lg"></i> Add Inject
  </button>
  <div>
    <button type="button" id="importTemplatesButton" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
      data-bs-target="#importTemplatesModal">
      <i class="bi bi-box-arrow-in-down"></i> Import
    </button>
    <button type="button" id="exportTemplatesButton" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
      data-bs-target="#exportTemplatesModal">
      <i class="bi bi-box-arrow-up"></i> Export
    </button>
  </div>
</div>
<div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="templates" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th>#</th>
        <th>Title</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Points</th>
        <th>Enabled</th>
        <th></th>
      </tr>
    </thead>
  </table>
</div>

<!-- Add Template Modal -->
<div class="modal fade" id="addTemplateModal" tabindex="-1" aria-labelledby="addTemplateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTemplateModalLabel">Add Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger d-none" id="addTemplateError"></div>
        <input type="hidden" id="addTemplateId" value="" />
        <form id="templateAddForm">
          <div class="mb-3">
            <label for="inputTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="inputTitle" placeholder="Journey to Mordor">
          </div>
          <div class="mb-3">
            <label for="inputScenario" class="form-label">Scenario</label>
            <textarea class="form-control" id="inputScenario" rows="3"
              placeholder="Supports Markdown formatting"></textarea>
          </div>
          <div class="mb-3">
            <label for="inputDeliverable" class="form-label">Deliverable</label>
            <textarea class="form-control" id="inputDeliverable" rows="3"
              placeholder="Supports Markdown formatting"></textarea>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="inputStartTime" class="form-label">Start Time</label>
              <input type="datetime-local" class="form-control" id="inputStartTime">
            </div>
            <div class="col-md-4">
              <label for="inputEndTime" class="form-label">End Time</label>
              <input type="datetime-local" class="form-control" id="inputEndTime">
            </div>
            <div class="col-md-4">
              <label for="inputStatus" class="form-label">Status</label>
              <select class="form-select" id="inputStatus">
                <option>Enabled</option>
                <option>Disabled</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Rubric Items</label>
            <table class="table table-sm" id="inputRubricItems">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Description</th>
                  <th>Points</th>
                  <th style="width:50px;"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input type="text" class="form-control form-control-sm rubric-title" placeholder="Overall Quality"></td>
                  <td><input type="text" class="form-control form-control-sm rubric-desc" placeholder=""></td>
                  <td><input type="number" class="form-control form-control-sm rubric-points" placeholder="100"></td>
                  <td><button type="button" class="btn btn-sm btn-outline-danger remove-rubric-row"><i class="bi bi-x-lg"></i></button></td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addRubricItemBtn">
              <i class="bi bi-plus-lg"></i> Add Rubric Item
            </button>
          </div>
          <div class="mb-3">
            <label class="form-label">Teams</label>
            <div class="mb-2">
              <button type="button" class="btn btn-sm btn-outline-secondary team-select-btn" data-target="#teams" data-action="all">All Teams</button>
              <button type="button" class="btn btn-sm btn-outline-primary team-select-btn" data-target="#teams" data-action="blue">All Blue</button>
              {% if red_teams %}
              <button type="button" class="btn btn-sm btn-outline-danger team-select-btn" data-target="#teams" data-action="red">All Red</button>
              {% endif %}
              <button type="button" class="btn btn-sm btn-outline-secondary team-select-btn" data-target="#teams" data-action="none">None</button>
            </div>
            <div class="row" id="teams">
              {% for blue_team in blue_teams %}
              <div class="col-sm-4">
                <div class="form-check">
                  <input class="form-check-input blue-team" type="checkbox" checked id="addTeam{{ blue_team.id }}">
                  <label class="form-check-label" for="addTeam{{ blue_team.id }}">{{ blue_team.name }}</label>
                </div>
              </div>
              {% endfor %}
              {% for red_team in red_teams %}
              <div class="col-sm-4">
                <div class="form-check">
                  <input class="form-check-input red-team" type="checkbox" id="addRedTeam{{ red_team.id }}">
                  <label class="form-check-label" for="addRedTeam{{ red_team.id }}">{{ red_team.name }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="addTemplateButton">Add Template</button>
      </div>
    </div>
  </div>
</div>

<!-- Update Template Modal -->
<div class="modal fade" id="updateTemplateModal" tabindex="-1" aria-labelledby="updateTemplateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateTemplateModalLabel">Update Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger d-none" id="updateTemplateError"></div>
        <input type="hidden" id="updateTemplateId" value="" />
        <form id="templateUpdateForm">
          <div class="mb-3">
            <label for="inputUpdateTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="inputUpdateTitle" placeholder="Journey to Mordor">
          </div>
          <div class="mb-3">
            <label for="inputUpdateScenario" class="form-label">Scenario</label>
            <textarea class="form-control" id="inputUpdateScenario" rows="3"
              placeholder="Supports Markdown formatting"></textarea>
          </div>
          <div class="mb-3">
            <label for="inputUpdateDeliverable" class="form-label">Deliverable</label>
            <textarea class="form-control" id="inputUpdateDeliverable" rows="3"
              placeholder="Supports Markdown formatting"></textarea>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="inputUpdateStartTime" class="form-label">Start Time</label>
              <input type="datetime-local" class="form-control" id="inputUpdateStartTime">
            </div>
            <div class="col-md-4">
              <label for="inputUpdateEndTime" class="form-label">End Time</label>
              <input type="datetime-local" class="form-control" id="inputUpdateEndTime">
            </div>
            <div class="col-md-4">
              <label for="inputUpdateStatus" class="form-label">Status</label>
              <select class="form-select" id="inputUpdateStatus">
                <option>Enabled</option>
                <option>Disabled</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Rubric Items</label>
            <table class="table table-sm" id="inputUpdateRubricItems">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Description</th>
                  <th>Points</th>
                  <th style="width:50px;"></th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addUpdateRubricItemBtn">
              <i class="bi bi-plus-lg"></i> Add Rubric Item
            </button>
          </div>
          <div class="mb-3">
            <label class="form-label">Teams</label>
            <div class="mb-2">
              <button type="button" class="btn btn-sm btn-outline-secondary team-select-btn" data-target="#updateTeams" data-action="all">All Teams</button>
              <button type="button" class="btn btn-sm btn-outline-primary team-select-btn" data-target="#updateTeams" data-action="blue">All Blue</button>
              {% if red_teams %}
              <button type="button" class="btn btn-sm btn-outline-danger team-select-btn" data-target="#updateTeams" data-action="red">All Red</button>
              {% endif %}
              <button type="button" class="btn btn-sm btn-outline-secondary team-select-btn" data-target="#updateTeams" data-action="none">None</button>
            </div>
            <div class="row" id="updateTeams">
              {% for blue_team in blue_teams %}
              <div class="col-sm-4">
                <div class="form-check">
                  <input class="form-check-input blue-team" type="checkbox" id="updateTeam{{ blue_team.id }}">
                  <label class="form-check-label" for="updateTeam{{ blue_team.id }}">{{ blue_team.name }}</label>
                </div>
              </div>
              {% endfor %}
              {% for red_team in red_teams %}
              <div class="col-sm-4">
                <div class="form-check">
                  <input class="form-check-input red-team" type="checkbox" id="updateRedTeam{{ red_team.id }}">
                  <label class="form-check-label" for="updateRedTeam{{ red_team.id }}">{{ red_team.name }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="updateTemplateButton">Update Template</button>
      </div>
    </div>
  </div>
</div>

<!-- Import Templates Modal -->
<div class="modal fade" id="importTemplatesModal" tabindex="-1" aria-labelledby="importTemplatesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importTemplatesModalLabel">Import Templates</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-warning mb-2"><i class="bi bi-exclamation-triangle"></i> Importing a template with an existing ID will overwrite it.</p>
        <textarea class="form-control" id="importTemplates" rows="10" placeholder="Paste YAML template data here..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="importTemplatesSubmit" class="btn btn-primary">Import</button>
      </div>
    </div>
  </div>
</div>

<!-- Export Templates Modal -->
<div class="modal fade" id="exportTemplatesModal" tabindex="-1" aria-labelledby="exportTemplatesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exportTemplatesModalLabel">Export Templates</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" id="exportTemplates" rows="10" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="templateDeleteModal" tabindex="-1" aria-labelledby="templateDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="templateDeleteModalLabel">Delete Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteTemplateId" value="" />
        <p>Are you sure you want to delete this template?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="templateDeleteButton" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Convert ISO datetime string to datetime-local input value (YYYY-MM-DDTHH:MM)
  function isoToDatetimeLocal(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    var year = d.getFullYear();
    var month = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    var hours = String(d.getHours()).padStart(2, '0');
    var minutes = String(d.getMinutes()).padStart(2, '0');
    return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
  }

  // Append browser timezone offset to a datetime-local value so the server parses it correctly
  function datetimeLocalToISO(dtLocalVal) {
    if (!dtLocalVal) return '';
    var d = new Date(dtLocalVal);
    var offset = -d.getTimezoneOffset();
    var sign = offset >= 0 ? '+' : '-';
    var absOffset = Math.abs(offset);
    var hh = String(Math.floor(absOffset / 60)).padStart(2, '0');
    var mm = String(absOffset % 60).padStart(2, '0');
    return dtLocalVal + ':00' + sign + hh + ':' + mm;
  }

  // Validate required fields in a form, returns true if valid
  function validateTemplateForm(prefix) {
    var isValid = true;
    var fields = [
      { id: prefix + 'Title', msg: 'Title is required' },
      { id: prefix + 'StartTime', msg: 'Start time is required' },
      { id: prefix + 'EndTime', msg: 'End time is required' },
    ];
    // Clear previous validation state
    fields.forEach(function(f) {
      var $el = $('#' + f.id);
      $el.removeClass('is-invalid');
      $el.next('.invalid-feedback').remove();
    });
    fields.forEach(function(f) {
      var $el = $('#' + f.id);
      if (!$el.val() || !$el.val().trim()) {
        $el.addClass('is-invalid');
        $el.after('<div class="invalid-feedback d-block">' + f.msg + '</div>');
        isValid = false;
      }
    });
    // Validate end time > start time if both present
    var startVal = $('#' + prefix + 'StartTime').val();
    var endVal = $('#' + prefix + 'EndTime').val();
    if (startVal && endVal && new Date(endVal) <= new Date(startVal)) {
      var $endEl = $('#' + prefix + 'EndTime');
      $endEl.addClass('is-invalid');
      $endEl.next('.invalid-feedback').remove();
      $endEl.after('<div class="invalid-feedback d-block">End time must be after start time</div>');
      isValid = false;
    }
    return isValid;
  }

  $(document).ready(function () {
    // Disable datatables error reporting
    $.fn.dataTable.ext.errMode = 'none';

    var localTz = moment.tz.guess();

    var dt = $('#templates').DataTable({
      "ajax": "/api/admin/injects/templates",
      "rowId": "id",
      "columns": [
        { "data": "id" },
        { "data": "title" },
        {
          "data": "start_time",
          "render": function (data, type, row) {
            return moment.parseZone(data).tz(localTz).format('YYYY-MM-DD hh:mm A z');
          }
        },
        {
          "data": "end_time",
          "render": function (data, type, row) {
            return moment.parseZone(data).tz(localTz).format('YYYY-MM-DD hh:mm A z');
          }
        },
        {
          "data": "max_score",
        },
        {
          "data": "enabled",
          "render": function (data, type, row) {
            if (data) {
              return '<span class="bi bi-check-lg text-success" aria-hidden="true"></span>';
            } else {
              return '<span class="bi bi-x-lg text-danger" aria-hidden="true"></span>';
            }
          }
        },
        {
          className: "text-end",
          width: "20%",
          render: function (data, type, row, meta) {
            return '<div class="btn-group float-end">' +
              '<button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">' +
              'Actions' +
              '</button>' +
              '<ul class="dropdown-menu">' +
              '<li><a class="dropdown-item template-view" href="#">View/Edit</a></li>' +
              '<li><a class="dropdown-item template-delete text-danger" href="#">Delete</a></li>' +
              '</ul>' +
              '</div>'
          }
        }
      ],
      "lengthChange": false,
      "ordering": false,
      "searching": false,
      "paging": false,
      "info": false,
    });

    // View/Edit Template
    $('#templates').on('click', '.template-view', function () {
      var data = dt.row($(this).closest('tr')).data();

      // Uncheck all checkboxes
      $('#updateTeams input:checkbox').prop('checked', false);

      // Query API for template data
      $.getJSON("/api/admin/injects/templates/" + data['id'])
        .done(function (data) {
          $('#updateTemplateId').val(data['id']);
          $('#inputUpdateTitle').val(data['title']);
          $('#inputUpdateScenario').val(data['scenario']);
          $('#inputUpdateDeliverable').val(data['deliverable']);
          $('#inputUpdateStartTime').val(isoToDatetimeLocal(data['start_time']));
          $('#inputUpdateEndTime').val(isoToDatetimeLocal(data['end_time']));

          if (data['enabled']) {
            $('#inputUpdateStatus').val('Enabled');
          } else {
            $('#inputUpdateStatus').val('Disabled');
          }

          // Populate rubric items
          var $rubricBody = $('#inputUpdateRubricItems tbody');
          $rubricBody.empty();
          if (data['rubric_items'] && data['rubric_items'].length > 0) {
            $.each(data['rubric_items'], function(i, item) {
              $rubricBody.append(
                '<tr>' +
                '<td><input type="text" class="form-control form-control-sm rubric-title" value="' + (item.title || '') + '"></td>' +
                '<td><input type="text" class="form-control form-control-sm rubric-desc" value="' + (item.description || '') + '"></td>' +
                '<td><input type="number" class="form-control form-control-sm rubric-points" value="' + (item.points || 0) + '"></td>' +
                '<td><button type="button" class="btn btn-sm btn-outline-danger remove-rubric-row"><i class="bi bi-x-lg"></i></button></td>' +
                '</tr>'
              );
            });
          }

          // Update team checkboxes
          const teams = data['teams'];
          $('#updateTeams input:checkbox').each(function () {
            if (teams.includes($(this).closest('.form-check').find('.form-check-label').text().trim())) {
              $(this).prop("checked", true);
            }
          });
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Failed to load template data:', textStatus, errorThrown);
          alert('Error loading template data. Please try again.');
        });

      var updateModal = new bootstrap.Modal(document.getElementById('updateTemplateModal'));
      updateModal.show();
    });

    // Delete Modal
    $('#templates').on('click', '.template-delete', function () {
      var data = dt.row($(this).closest('tr')).data();
      $('#deleteTemplateId').val(data['id']);
      var deleteModal = new bootstrap.Modal(document.getElementById('templateDeleteModal'));
      deleteModal.show();
    });

    // Import Modal
    $('#importTemplatesSubmit').on('click', function () {
      var data = jsyaml.load($('#importTemplates').val());
      $.ajax({
        url: "/api/admin/injects/templates/import",
        type: 'POST',
        data: JSON.stringify(data),
        contentType: "application/json",
        dataType: "json",
        success: function (result) {
          bootstrap.Modal.getInstance(document.getElementById('importTemplatesModal')).hide();
          dt.ajax.reload();
        },
        error: function (result) {
          console.error(result['responseJSON']['status']);
        }
      });
    });

    // Export Modal
    $('#exportTemplatesButton').on('click', function () {
      $.getJSON("/api/admin/injects/templates")
        .done(function (data) {
          $('#exportTemplates').val(jsyaml.dump(data.data));
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Failed to export templates:', textStatus, errorThrown);
          alert('Error exporting templates. Please try again.');
        });
    });

    // Delete Template Confirmation
    $('#templateDeleteButton').on('click', function () {
      const templateId = $('#deleteTemplateId').val();
      $.ajax({
        url: "/api/admin/injects/templates/" + templateId,
        type: 'DELETE',
        success: function (result) {
          $('#deleteTemplateId').val('');
          bootstrap.Modal.getInstance(document.getElementById('templateDeleteModal')).hide();
          dt.ajax.reload();
        },
        error: function (result) {
          console.error(result['responseJSON']['status']);
        }
      });
    });

    // Add Template Submit
    var $teamsContainer = $('#teams');
    var $addTemplateModal = $('#addTemplateModal');

    $('#addTemplateButton').on('click', function () {
      $('#addTemplateError').addClass('d-none').text('');
      if (!validateTemplateForm('input')) return;

      var templateData = {};

      templateData['title'] = $('#inputTitle').val();
      templateData['scenario'] = $('#inputScenario').val();
      templateData['deliverable'] = $('#inputDeliverable').val();
      templateData['start_time'] = datetimeLocalToISO($('#inputStartTime').val());
      templateData['end_time'] = datetimeLocalToISO($('#inputEndTime').val());
      templateData['status'] = $('#inputStatus').val();

      var rubricItems = [];
      $('#inputRubricItems tbody tr').each(function(i) {
        var title = $(this).find('.rubric-title').val();
        var desc = $(this).find('.rubric-desc').val();
        var points = parseInt($(this).find('.rubric-points').val()) || 0;
        if (title) {
          rubricItems.push({ title: title, description: desc, points: points, order: i });
        }
      });
      templateData['rubric_items'] = rubricItems;

      var selectedTeams = [];
      $teamsContainer.find('input:checked').each(function () {
        selectedTeams.push($(this).closest('.form-check').find('.form-check-label').text().trim());
      });
      templateData['selectedTeams'] = selectedTeams;

      var unselectedTeams = [];
      $teamsContainer.find('input:not(:checked)').each(function () {
        unselectedTeams.push($(this).closest('.form-check').find('.form-check-label').text().trim());
      });
      templateData['unselectedTeams'] = unselectedTeams;

      $.ajax({
        url: "/api/admin/injects/templates",
        type: 'POST',
        data: JSON.stringify(templateData),
        contentType: "application/json",
        dataType: "json",
        success: function (result) {
          bootstrap.Modal.getInstance($addTemplateModal[0]).hide();
          dt.ajax.reload();
        },
        error: function (result) {
          var msg = (result.responseJSON && (result.responseJSON.message || result.responseJSON.status)) || 'An error occurred';
          $('#addTemplateError').removeClass('d-none').text(msg);
        }
      });
    });

    // Update Template Submit
    var $updateTeamsContainer = $('#updateTeams');
    var $updateTemplateModal = $('#updateTemplateModal');

    $('#updateTemplateButton').on('click', function () {
      $('#updateTemplateError').addClass('d-none').text('');
      if (!validateTemplateForm('inputUpdate')) return;

      var templateData = {};

      const templateId = $('#updateTemplateId').val();

      templateData['title'] = $('#inputUpdateTitle').val();
      templateData['scenario'] = $('#inputUpdateScenario').val();
      templateData['deliverable'] = $('#inputUpdateDeliverable').val();
      templateData['start_time'] = datetimeLocalToISO($('#inputUpdateStartTime').val());
      templateData['end_time'] = datetimeLocalToISO($('#inputUpdateEndTime').val());
      templateData['status'] = $('#inputUpdateStatus').val();

      var rubricItems = [];
      $('#inputUpdateRubricItems tbody tr').each(function(i) {
        var title = $(this).find('.rubric-title').val();
        var desc = $(this).find('.rubric-desc').val();
        var points = parseInt($(this).find('.rubric-points').val()) || 0;
        if (title) {
          rubricItems.push({ title: title, description: desc, points: points, order: i });
        }
      });
      templateData['rubric_items'] = rubricItems;

      var selectedTeams = [];
      $updateTeamsContainer.find('input:checked').each(function () {
        selectedTeams.push($(this).closest('.form-check').find('.form-check-label').text().trim());
      });
      templateData['selectedTeams'] = selectedTeams;

      var unselectedTeams = [];
      $updateTeamsContainer.find('input:not(:checked)').each(function () {
        unselectedTeams.push($(this).closest('.form-check').find('.form-check-label').text().trim());
      });
      templateData['unselectedTeams'] = unselectedTeams;

      $.ajax({
        url: "/api/admin/injects/templates/" + templateId,
        type: 'PUT',
        data: JSON.stringify(templateData),
        contentType: "application/json",
        dataType: "json",
        success: function (result) {
          bootstrap.Modal.getInstance($updateTemplateModal[0]).hide();
          dt.ajax.reload(null, false);
        },
        error: function (result) {
          var msg = (result.responseJSON && (result.responseJSON.message || result.responseJSON.status)) || 'An error occurred';
          $('#updateTemplateError').removeClass('d-none').text(msg);
        }
      });
    });

    // Add rubric item row (Add modal)
    $('#addRubricItemBtn').on('click', function() {
      $('#inputRubricItems tbody').append(
        '<tr>' +
        '<td><input type="text" class="form-control form-control-sm rubric-title" placeholder="Item title"></td>' +
        '<td><input type="text" class="form-control form-control-sm rubric-desc" placeholder=""></td>' +
        '<td><input type="number" class="form-control form-control-sm rubric-points" placeholder="0"></td>' +
        '<td><button type="button" class="btn btn-sm btn-outline-danger remove-rubric-row"><i class="bi bi-x-lg"></i></button></td>' +
        '</tr>'
      );
    });

    // Add rubric item row (Update modal)
    $('#addUpdateRubricItemBtn').on('click', function() {
      $('#inputUpdateRubricItems tbody').append(
        '<tr>' +
        '<td><input type="text" class="form-control form-control-sm rubric-title" placeholder="Item title"></td>' +
        '<td><input type="text" class="form-control form-control-sm rubric-desc" placeholder=""></td>' +
        '<td><input type="number" class="form-control form-control-sm rubric-points" placeholder="0"></td>' +
        '<td><button type="button" class="btn btn-sm btn-outline-danger remove-rubric-row"><i class="bi bi-x-lg"></i></button></td>' +
        '</tr>'
      );
    });

    // Remove rubric item row
    $(document).on('click', '.remove-rubric-row', function() {
      $(this).closest('tr').remove();
    });

    // Team quick-select buttons
    $(document).on('click', '.team-select-btn', function() {
      var target = $(this).data('target');
      var action = $(this).data('action');
      if (action === 'all') {
        $(target).find('input:checkbox').prop('checked', true);
      } else if (action === 'none') {
        $(target).find('input:checkbox').prop('checked', false);
      } else if (action === 'blue') {
        $(target).find('input:checkbox').prop('checked', false);
        $(target).find('input.blue-team').prop('checked', true);
      } else if (action === 'red') {
        $(target).find('input:checkbox').prop('checked', false);
        $(target).find('input.red-team').prop('checked', true);
      }
    });

    // Clear validation on input
    $(document).on('input change', '.is-invalid', function() {
      $(this).removeClass('is-invalid');
      $(this).next('.invalid-feedback').remove();
    });
  });
</script>
{% endblock %}
