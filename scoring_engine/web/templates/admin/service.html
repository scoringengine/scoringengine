{% extends 'admin/adminbase.html' %}
{% block title %}Admin - {{service.name}} - {{service.team.name}}{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" rel="stylesheet" />
{% endblock %}

{% block header %}{{service.team.name}} - {{service.name}}{% endblock %}

{% block admincontent %}
<div class="pt-3">
  <div class="row">
    <div class="col-md-6">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label fw-bold">Host</label>
            <input type="text" class="form-control editable-field"
                   data-pk="{{service.id}}" data-name="host"
                   data-url="{{url_for('api.update_host')}}"
                   value="{{service.host}}">
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label fw-bold">Port</label>
            <input type="text" class="form-control editable-field"
                   data-pk="{{service.id}}" data-name="port"
                   data-url="{{url_for('api.update_port')}}"
                   value="{{service.port}}">
          </div>
        </div>
      </div>

      <h3 class="section-header">Accounts</h3>
      {% if service.accounts %}
      <div class="chart-card" style="padding:0; overflow:hidden;">
      <table class="table table-sm overview-matrix">
        <thead>
          <tr>
            <th style="width: 30%">Username</th>
            <th>Password</th>
          </tr>
        </thead>
        <tbody>
          {% for account in service.accounts %}
          <tr>
            <td>
              <input type="text" class="form-control form-control-sm editable-field"
                     data-pk="{{account.id}}" data-name="username"
                     data-url="{{url_for('api.update_service_account_info')}}"
                     value="{{account.username}}">
            </td>
            <td>
              <div class="input-group">
                <input type="password" class="form-control form-control-sm editable-field password-field"
                       data-pk="{{account.id}}" data-name="password"
                       data-url="{{url_for('api.update_service_account_info')}}"
                       value="{{account.password}}">
                <button class="btn btn-outline-secondary btn-sm toggle-password" type="button">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      {% else %}
      <p class="text-muted">No Accounts Found.</p>
      {% endif %}
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-bold">Worker Queue Name</label>
        <input type="text" class="form-control editable-field"
               data-pk="{{service.id}}" data-name="worker_queue"
               data-url="{{url_for('api.admin_update_worker_queue')}}"
               value="{{service.worker_queue}}">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Points per Check</label>
        <input type="text" class="form-control editable-field"
               data-pk="{{service.id}}" data-name="points"
               data-url="{{url_for('api.admin_update_points')}}"
               value="{{service.points}}">
      </div>
    </div>
  </div>

  <h3 class="section-header">Environments</h3>
  {% if service.environments %}
  <div class="chart-card" style="padding:0; overflow:hidden;">
  <table class="table table-sm overview-matrix">
    <thead>
      <tr>
        <th style="width: 20%">Matching Content</th>
        <th style="width: 20%">Reject Content</th>
        <th>Properties</th>
      </tr>
    </thead>
    <tbody>
      {% for environment in service.environments %}
      <tr>
        <td class="align-top">
          <input type="text" class="form-control form-control-sm editable-field"
                 data-pk="{{environment.id}}" data-name="matching_content"
                 data-url="{{url_for('api.admin_update_environment')}}"
                 value="{{environment.matching_content}}">
        </td>
        <td class="align-top">
          <input type="text" class="form-control form-control-sm editable-field"
                 data-pk="{{environment.id}}" data-name="matching_content_reject"
                 data-url="{{url_for('api.admin_update_environment')}}"
                 value="{{environment.matching_content_reject or ''}}"
                 placeholder="Optional reject regex">
        </td>
        <td>
          {% if environment.properties %}
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th style="width: 30%">Name</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              {% for property_obj in environment.properties %}
              <tr>
                <td>
                  <input type="text" class="form-control form-control-sm editable-field"
                         data-pk="{{property_obj.id}}" data-name="property_name"
                         data-url="{{url_for('api.admin_update_property')}}"
                         value="{{property_obj.name}}">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm editable-field"
                         data-pk="{{property_obj.id}}" data-name="property_value"
                         data-url="{{url_for('api.admin_update_property')}}"
                         value="{{property_obj.value}}">
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <span class="text-muted">No Properties Found.</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
  <p class="text-muted">No Environments Found.</p>
  {% endif %}

  <h3 class="section-header">Checks</h3>
  <div class="chart-card" style="padding:0; overflow:hidden;">
  <table id="checks" class="table table-sm overview-matrix" width="100%">
    <thead>
      <tr>
        <th></th>
        <th>Round</th>
        <th>Result</th>
        <th>Earned</th>
        <th>Reason</th>
        <th>Command</th>
        <th>Timestamp</th>
      </tr>
    </thead>
  </table>
  </div>
</div>

<script>
  $(document).ready(function() {
    // Auto-save editable fields on change
    function setupEditableFields(selector) {
      $(selector).off('change.editable').on('change.editable', function() {
        var $input = $(this);
        var originalValue = $input.data('original-value');
        var newValue = $input.val().trim();

        // Don't save if value hasn't changed
        if (newValue === originalValue) return;

        var pk = $input.data('pk');
        var name = $input.data('name');
        var url = $input.data('url');

        $.ajax({
          url: url,
          type: 'POST',
          data: {
            pk: pk,
            name: name,
            value: newValue
          },
          success: function(response) {
            if (response.error) {
              $input.addClass('is-invalid');
              alert('Error: ' + response.error);
              $input.val(originalValue);
            } else {
              $input.removeClass('is-invalid').addClass('is-valid');
              $input.data('original-value', newValue);
              setTimeout(function() {
                $input.removeClass('is-valid');
              }, 2000);
            }
          },
          error: function(xhr) {
            $input.addClass('is-invalid');
            var msg = 'Error saving';
            try {
              msg = xhr.responseJSON.error || xhr.responseJSON.status || msg;
            } catch(e) {}
            alert(msg);
            $input.val(originalValue);
          }
        });
      });

      // Store original values
      $(selector).each(function() {
        if (!$(this).data('original-value')) {
          $(this).data('original-value', $(this).val());
        }
      });
    }

    // Initialize editable fields
    setupEditableFields('.editable-field');

    // Toggle password visibility
    $('.toggle-password').on('click', function() {
      var $btn = $(this);
      var $input = $btn.closest('.input-group').find('input');
      var $icon = $btn.find('i');

      if ($input.attr('type') === 'password') {
        $input.attr('type', 'text');
        $icon.removeClass('bi-eye').addClass('bi-eye-slash');
      } else {
        $input.attr('type', 'password');
        $icon.removeClass('bi-eye-slash').addClass('bi-eye');
      }
    });

    // Disable datatables error reporting
    $.fn.dataTable.ext.errMode = 'none';

    var dt = $('#checks').DataTable({
      "ajax": "/api/service/{{ service.id }}/checks",
      "columns": [{
        "class": "details-control",
        "orderable": false,
        "data": null,
        "defaultContent": "",
        "width": "5%",
      },
      {
        "data": "round",
        "width": "8%"
      },
      {
        "data": "result",
        "width": "10%",
        "render": function(data, type, row) {
          var passSelected = data ? 'selected' : '';
          var failSelected = data ? '' : 'selected';
          return '<select class="form-select form-select-sm check-result-select" data-pk="' + row['id'] + '">' +
            '<option value="1" ' + passSelected + '>Pass</option>' +
            '<option value="2" ' + failSelected + '>Fail</option>' +
            '</select>';
        }
      },
      {
        "data": "earned_score",
        "width": "10%",
        "render": function(data, type, row) {
          var modifierText = '';
          if (row.multiplier != 1.0) {
            modifierText += ' <small class="text-muted">(' + row.multiplier + 'x)</small>';
          }
          if (row.sla_penalty > 0) {
            modifierText += ' <small class="text-danger">(-' + row.sla_penalty + '%)</small>';
          }
          return data + modifierText;
        }
      },
      {
        "data": "reason",
        "width": "25%",
        "render": function(data, type, row) {
          return '<input type="text" class="form-control form-control-sm editable-field check-reason-field" ' +
                 'data-pk="' + row['id'] + '" data-name="check_reason" ' +
                 'data-url="{{url_for('api.admin_update_check')}}" ' +
                 'value="' + (data || '').replace(/"/g, '&quot;') + '">';
        }
      },
      {
        "data": "command",
        "width": "17%",
      },
      {
        "data": "timestamp",
        "width": "20%",
      }
      ],
      'paging': true,
      'bFilter': false,
      'bInfo': false,
      "order": [[1, 'desc']]
    });

    // Array to track the ids of the details displayed rows
    var detailRows = [];

    $('#checks tbody').on('click', 'tr td.details-control', function() {
      var tr = $(this).closest('tr');
      var row = dt.row(tr);
      var idx = $.inArray(tr.attr('id'), detailRows);

      if (row.child.isShown()) {
        tr.removeClass('shown');
        row.child.hide();
        detailRows.splice(idx, 1);
      } else {
        tr.addClass('shown');
        row.child('<pre style="max-height: 350px; min-height: 10px;">' + row.data().output + '</pre>').show();
        if (idx === -1) {
          detailRows.push(tr.attr('id'));
        }
      }
    });

    // Handle check result dropdown change
    $('#checks tbody').on('change', '.check-result-select', function() {
      var $select = $(this);
      var pk = $select.data('pk');
      var value = $select.val();

      $select.prop('disabled', true);

      $.ajax({
        url: '{{url_for("api.admin_update_check")}}',
        type: 'POST',
        data: {
          pk: pk,
          name: 'check_value',
          value: value
        },
        success: function(response) {
          if (response.error) {
            alert('Error: ' + response.error);
            $select.prop('disabled', false);
          } else {
            // Reload table to show updated scores
            dt.ajax.reload(null, false);
          }
        },
        error: function(xhr) {
          alert('Error updating check result');
          $select.prop('disabled', false);
        }
      });
    });

    dt.on('draw', function() {
      // Re-initialize inline editing for dynamically added elements
      setupEditableFields('#checks .editable-field');

      // On each draw, loop over the `detailRows` array and show any child rows
      $.each(detailRows, function(i, id) {
        $('#' + id + ' td.details-control').trigger('click');
      });
    });
  });
</script>
{% endblock %}
