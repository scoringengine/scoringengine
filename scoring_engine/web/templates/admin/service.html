{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Teams{% endblock %}

{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.bootstrap.min.js') }}"></script>
    <link href="{{ url_for('static', filename='css/dataTables.bootstrap.min.css') }}" rel="stylesheet" />

    <script src="{{ url_for('static', filename='js/bootstrap-editable.min.js') }}"></script>
    <link href="{{ url_for('static', filename='css/bootstrap-editable.css') }}" rel="stylesheet" />

    <script>
        $.fn.editable.defaults.mode = 'inline';

        $(function(){
            //enable / disable
            $('#enable').click(function() {
                $('.editable-table .editable').editable('toggleDisabled');
            });

            //editables
            $('.editable-textfield').editable({
                type: 'text',
                validate: function(value) {
                    if($.trim(value) == '') return 'This field is required';
                }
            });

            //editables
            $('.editable-dropdown').editable({
                type: 'select',
                validate: function(value) {
                    if($.trim(value) == '') return 'This field is required';
                }
            });

            $('.editable-table .editable').on('hidden', function(e, reason){
                if(reason === 'save' || reason === 'nochange') {
                    var $next = $(this).closest('tr').next().find('.editable');
                    if($('#autoopen').is(':checked')) {
                        setTimeout(function() {
                            $next.editable('show');
                        }, 300);
                    } else {
                        $next.focus();
                    }
                }
            });
        });
    </script>
{% endblock %}

{% block admincontent %}
<div class="container">
    <div class="row">
        <div class="col-sm-3 col-md-3">
            <div class="panel-group" id="accordion">
                {% for team in teams %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse{{team.id}}">
                            </span>{{team.name}}</a>
                        </h4>
                    </div>
                    <div id="collapse{{team.id}}" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table">
                                {% for service_obj in team.services %}
                                <tr>
                                    <td>
                                        <a href="/admin/service/{{service_obj.id}}">{{service_obj.name}}</a></span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
          <div class="col-sm-9 col-md-9">
              <h3>{{service.team.name}}</h3>
              <h4>{{service.name}}</h4>
              <h5>IP Address: <a href="#" class="editable-textfield" data-type="text" data-pk="{{service.id}}" data-title="Enter IP Address" data-name="ip_address" data-url='/api/admin/update_ip_address'>{{service.ip_address}}</a></h5>
              {% if service.accounts %}
                  <h4>Accounts</h4>
                  <table class="table table-striped table-bordered table-compact editable-table" style="clear: both">
                      <thead>
                            <tr>
                              <th>Username</th>
                              <th>Password</th>
                            </tr>
                          </thead>
                      <tbody>
                          {% for account in service.accounts %}
                                  <tr>
                                      <td width="30%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{account.id}}" data-title="Enter Username" data-name="username" data-url='/api/admin/update_account_info'>{{account.username}}</a></td>
                                      <td width="70%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{account.id}}" data-title="Enter Password" data-name="password" data-url='/api/admin/update_account_info'>{{account.password}}</a></td>
                                  </tr>
                            {% endfor %}
                      </tbody>
                  </table>
              {% endif %}
              {% if service.environments %}
                  <h4>Environments</h4>
                  <table class="table table-striped table-bordered table-compact" style="clear: both">
                      <thead>
                        <tr>
                          <th>Matching Regex</th>
                          <th>Properties</th>
                        </tr>
                      </thead>
                      <tbody>
                          {% for environment in service.environments %}
                                  <tr>
                                      <td width="40%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{environment.id}}" data-title="Enter Matching Regex" data-url='/api/admin/update_environment_info' data-name='matching_regex'>{{environment.matching_regex}}</a></td>
                                      <td>
                                          {% if environment.properties %}
                                          <table class="table table-striped table-bordered table-compact" style="clear: both">
                                              <thead>
                                                  <tr>
                                                      <th>Name</th>
                                                      <th>Value</th>
                                                  </tr>
                                              </thead>
                                              <tbody>
                                              {% for property_obj in environment.properties %}
                                                  <tr>
                                                      <td width="50%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{property_obj.id}}" data-title="Enter Property Name" data-url='/api/admin/update_property' data-name='property_name'>{{property_obj.name}}</a></td>
                                                      <td width="50%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{property_obj.id}}" data-title="Enter Property Value" data-url='/api/admin/update_property' data-name='property_value'>{{property_obj.value}}</a></td>
                                                  </tr>
                                              {% endfor %}
                                              </tbody>
                                          </table>
                                        {% else %}
                                          No properties defined
                                        {% endif %}
                                      </td>
                                  </tr>
                            {% endfor %}
                      </tbody>
                  </table>
              {% endif %}

              <h4>Checks</h4>
              <table id="checks{{service.id}}" class="table table-striped table-bordered table-compact" cellspacing="0" width="100%">
                <thead>
                  <tr>
                    <th>Round Number</th>
                    <th>Result</th>
                    <th>Reason</th>
                    <th>Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  {% for check in service.checks_reversed %}
                    <tr>
                      {% if check.result %}
                          {% set data_value = '1' %}
                          {% set check_value = 'Pass' %}
                      {% else %}
                          {% set data_value = '2' %}
                          {% set check_value = 'Fail' %}
                      {% endif %}
                      <td width="20%">{{check.round.number}}</td>
                      <td width="20%"><a href="#" class="editable-dropdown" data-pk="{{check.id}}" data-value="{{data_value}}" data-source='[{value: 1, text: "Pass"}, {value: 2, text: "Fail"}]' data-title="Select Result" data-url='/api/admin/update_check' data-name='check_value'>{{check_value}}</a></td>
                      <td width="30%"><a href="#" class="editable-textfield" data-type="text" data-pk="{{check.id}}" data-title="Enter Reason" data-url='/api/admin/update_check' data-name='check_reason'>{{check.reason}}</a></td>
                      <td width="30%">{{check.completed_timestamp}}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <script>
                  $(document).ready(function() {
                      $('#checks{{service.id}}').DataTable({
                          'paging': true,
                          'bFilter': false,
                          'bInfo': false,
                          "order": [[ 0, "desc" ]]
                      });
                  } );
              </script>
            </div>
        }
        }


    </div>
</div>
{% endblock %}