{% extends 'admin/adminbase.html' %}
{% block title %}Admin - Announcements{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block header %}Announcements{% endblock %}

{% block admincontent %}
<div class="pt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <p class="text-muted mb-0">Manage announcements visible to teams during the competition.</p>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
      <i class="bi bi-plus-lg"></i> New Announcement
    </button>
  </div>

  <div id="announcements-list">
    <div class="text-center py-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>
</div>

<!-- Create Announcement Modal -->
<div class="modal fade" id="createAnnouncementModal" tabindex="-1" aria-labelledby="createAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createAnnouncementModalLabel">Create Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-announcement-form">
          <div class="mb-3">
            <label for="create-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="create-title" required maxlength="255">
          </div>
          <div class="mb-3">
            <label for="create-content" class="form-label">Content</label>
            <textarea class="form-control" id="create-content" rows="5" required></textarea>
            <div class="form-text">HTML is supported for formatting.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Audience</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="create-audience" id="create-audience-global" value="global" checked>
              <label class="form-check-label" for="create-audience-global">
                Global (Everyone)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="create-audience" id="create-audience-blue" value="all_blue">
              <label class="form-check-label" for="create-audience-blue">
                All Blue Teams
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="create-audience" id="create-audience-red" value="all_red">
              <label class="form-check-label" for="create-audience-red">
                Red Team Only
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="create-audience" id="create-audience-specific" value="specific">
              <label class="form-check-label" for="create-audience-specific">
                Specific Teams
              </label>
            </div>
          </div>
          <div class="mb-3 d-none" id="create-teams-select-container">
            <label for="create-teams-select" class="form-label">Select Teams</label>
            <select class="form-select" id="create-teams-select" multiple size="5">
              <!-- Populated dynamically -->
            </select>
            <div class="form-text">Hold Ctrl/Cmd to select multiple teams.</div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="create-pinned">
                  <label class="form-check-label" for="create-pinned">
                    <i class="bi bi-pin-angle-fill"></i> Pin to top
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="create-expires" class="form-label">Expires At (optional)</label>
                <input type="datetime-local" class="form-control" id="create-expires">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="create-announcement-btn">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAnnouncementModalLabel">Edit Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-announcement-form">
          <input type="hidden" id="edit-id">
          <div class="mb-3">
            <label for="edit-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="edit-title" required maxlength="255">
          </div>
          <div class="mb-3">
            <label for="edit-content" class="form-label">Content</label>
            <textarea class="form-control" id="edit-content" rows="5" required></textarea>
            <div class="form-text">HTML is supported for formatting.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Audience</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="edit-audience" id="edit-audience-global" value="global">
              <label class="form-check-label" for="edit-audience-global">
                Global (Everyone)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="edit-audience" id="edit-audience-blue" value="all_blue">
              <label class="form-check-label" for="edit-audience-blue">
                All Blue Teams
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="edit-audience" id="edit-audience-red" value="all_red">
              <label class="form-check-label" for="edit-audience-red">
                Red Team Only
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="edit-audience" id="edit-audience-specific" value="specific">
              <label class="form-check-label" for="edit-audience-specific">
                Specific Teams
              </label>
            </div>
          </div>
          <div class="mb-3 d-none" id="edit-teams-select-container">
            <label for="edit-teams-select" class="form-label">Select Teams</label>
            <select class="form-select" id="edit-teams-select" multiple size="5">
              <!-- Populated dynamically -->
            </select>
            <div class="form-text">Hold Ctrl/Cmd to select multiple teams.</div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="edit-pinned">
                  <label class="form-check-label" for="edit-pinned">
                    <i class="bi bi-pin-angle-fill"></i> Pin to top
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="edit-active" checked>
                  <label class="form-check-label" for="edit-active">
                    Active
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="edit-expires" class="form-label">Expires At</label>
                <input type="datetime-local" class="form-control" id="edit-expires">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-announcement-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAnnouncementModal" tabindex="-1" aria-labelledby="deleteAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAnnouncementModalLabel">Delete Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this announcement?</p>
        <p class="fw-bold" id="delete-announcement-title"></p>
      </div>
      <div class="modal-footer">
        <input type="hidden" id="delete-id">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
var teams = [];

function formatAudience(audience) {
  if (audience === 'global') return '<span class="badge bg-secondary">Global</span>';
  if (audience === 'all_blue') return '<span class="badge bg-primary">All Blue</span>';
  if (audience === 'all_red') return '<span class="badge bg-danger">Red Team</span>';
  if (audience.startsWith('team:')) {
    var teamId = audience.split(':')[1];
    var team = teams.find(t => t.id == teamId);
    return '<span class="badge bg-info">Team: ' + (team ? team.name : teamId) + '</span>';
  }
  if (audience.startsWith('teams:')) {
    var teamIds = audience.split(':')[1].split(',');
    var teamNames = teamIds.map(function(id) {
      var team = teams.find(t => t.id == id.trim());
      return team ? team.name : id;
    });
    return '<span class="badge bg-info">Teams: ' + teamNames.join(', ') + '</span>';
  }
  return '<span class="badge bg-secondary">' + audience + '</span>';
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  return date.toLocaleString();
}

function loadTeams() {
  $.ajax({
    url: '/api/admin/teams/list',
    method: 'GET',
    success: function(data) {
      teams = data.data;
      var options = '';
      teams.forEach(function(team) {
        options += '<option value="' + team.id + '">' + team.name + ' (' + team.color + ')</option>';
      });
      $('#create-teams-select').html(options);
      $('#edit-teams-select').html(options);
    }
  });
}

function loadAnnouncements() {
  $.ajax({
    url: '/api/admin/announcements',
    method: 'GET',
    success: function(data) {
      var html = '';
      if (data.data.length === 0) {
        html = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> No announcements yet. Create one to get started.</div>';
      } else {
        html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Title</th><th>Audience</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>';
        html += '<tbody>';
        data.data.forEach(function(a) {
          var statusBadges = '';
          if (a.is_pinned) statusBadges += '<span class="badge bg-warning text-dark me-1"><i class="bi bi-pin-angle-fill"></i> Pinned</span>';
          if (!a.is_active) statusBadges += '<span class="badge bg-secondary me-1">Inactive</span>';
          else statusBadges += '<span class="badge bg-success me-1">Active</span>';
          if (a.expires_at) {
            var expires = new Date(a.expires_at);
            if (expires < new Date()) {
              statusBadges += '<span class="badge bg-danger me-1">Expired</span>';
            }
          }

          html += '<tr>';
          html += '<td><strong>' + $('<div>').text(a.title).html() + '</strong></td>';
          html += '<td>' + formatAudience(a.audience) + '</td>';
          html += '<td>' + statusBadges + '</td>';
          html += '<td><small>' + formatDate(a.created_at) + '</small></td>';
          html += '<td>';
          html += '<button class="btn btn-sm btn-outline-primary me-1" onclick="editAnnouncement(' + a.id + ')" title="Edit"><i class="bi bi-pencil"></i></button>';
          html += '<button class="btn btn-sm btn-outline-' + (a.is_pinned ? 'warning' : 'secondary') + ' me-1" onclick="togglePin(' + a.id + ')" title="Toggle Pin"><i class="bi bi-pin-angle"></i></button>';
          html += '<button class="btn btn-sm btn-outline-' + (a.is_active ? 'success' : 'secondary') + ' me-1" onclick="toggleActive(' + a.id + ')" title="Toggle Active"><i class="bi bi-eye"></i></button>';
          html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(' + a.id + ', \'' + $('<div>').text(a.title).html().replace(/'/g, "\\'") + '\')" title="Delete"><i class="bi bi-trash"></i></button>';
          html += '</td>';
          html += '</tr>';
        });
        html += '</tbody></table></div>';
      }
      $('#announcements-list').html(html);
    }
  });
}

function getAudienceValue() {
  var selected = $('input[name="create-audience"]:checked').val();
  if (selected === 'specific') {
    var teamIds = $('#create-teams-select').val();
    if (teamIds && teamIds.length === 1) {
      return 'team:' + teamIds[0];
    } else if (teamIds && teamIds.length > 1) {
      return 'teams:' + teamIds.join(',');
    }
    return 'global';
  }
  return selected;
}

function getEditAudienceValue() {
  var selected = $('input[name="edit-audience"]:checked').val();
  if (selected === 'specific') {
    var teamIds = $('#edit-teams-select').val();
    if (teamIds && teamIds.length === 1) {
      return 'team:' + teamIds[0];
    } else if (teamIds && teamIds.length > 1) {
      return 'teams:' + teamIds.join(',');
    }
    return 'global';
  }
  return selected;
}

function editAnnouncement(id) {
  $.ajax({
    url: '/api/admin/announcements/' + id,
    method: 'GET',
    success: function(data) {
      var a = data.data;
      $('#edit-id').val(a.id);
      $('#edit-title').val(a.title);
      $('#edit-content').val(a.content);
      $('#edit-pinned').prop('checked', a.is_pinned);
      $('#edit-active').prop('checked', a.is_active);

      if (a.expires_at) {
        var date = new Date(a.expires_at);
        var localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
        $('#edit-expires').val(localDate.toISOString().slice(0, 16));
      } else {
        $('#edit-expires').val('');
      }

      // Set audience
      if (a.audience === 'global') {
        $('#edit-audience-global').prop('checked', true);
        $('#edit-teams-select-container').addClass('d-none');
      } else if (a.audience === 'all_blue') {
        $('#edit-audience-blue').prop('checked', true);
        $('#edit-teams-select-container').addClass('d-none');
      } else if (a.audience === 'all_red') {
        $('#edit-audience-red').prop('checked', true);
        $('#edit-teams-select-container').addClass('d-none');
      } else if (a.audience.startsWith('team:') || a.audience.startsWith('teams:')) {
        $('#edit-audience-specific').prop('checked', true);
        $('#edit-teams-select-container').removeClass('d-none');
        var teamIds = a.audience.replace('teams:', '').replace('team:', '').split(',');
        $('#edit-teams-select').val(teamIds);
      }

      $('#editAnnouncementModal').modal('show');
    }
  });
}

function togglePin(id) {
  $.ajax({
    url: '/api/admin/announcements/' + id + '/toggle_pin',
    method: 'POST',
    success: function() {
      loadAnnouncements();
    }
  });
}

function toggleActive(id) {
  $.ajax({
    url: '/api/admin/announcements/' + id + '/toggle_active',
    method: 'POST',
    success: function() {
      loadAnnouncements();
    }
  });
}

function deleteAnnouncement(id, title) {
  $('#delete-id').val(id);
  $('#delete-announcement-title').text(title);
  $('#deleteAnnouncementModal').modal('show');
}

$(document).ready(function() {
  loadTeams();
  loadAnnouncements();

  // Toggle teams select visibility
  $('input[name="create-audience"]').change(function() {
    if ($(this).val() === 'specific') {
      $('#create-teams-select-container').removeClass('d-none');
    } else {
      $('#create-teams-select-container').addClass('d-none');
    }
  });

  $('input[name="edit-audience"]').change(function() {
    if ($(this).val() === 'specific') {
      $('#edit-teams-select-container').removeClass('d-none');
    } else {
      $('#edit-teams-select-container').addClass('d-none');
    }
  });

  // Create announcement
  $('#create-announcement-btn').click(function() {
    var data = {
      title: $('#create-title').val(),
      content: $('#create-content').val(),
      audience: getAudienceValue(),
      is_pinned: $('#create-pinned').is(':checked'),
      expires_at: $('#create-expires').val() || null
    };

    $.ajax({
      url: '/api/admin/announcements',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function() {
        $('#createAnnouncementModal').modal('hide');
        $('#create-announcement-form')[0].reset();
        $('#create-teams-select-container').addClass('d-none');
        loadAnnouncements();
      },
      error: function(xhr) {
        alert('Error creating announcement: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
      }
    });
  });

  // Save announcement changes
  $('#save-announcement-btn').click(function() {
    var id = $('#edit-id').val();
    var data = {
      title: $('#edit-title').val(),
      content: $('#edit-content').val(),
      audience: getEditAudienceValue(),
      is_pinned: $('#edit-pinned').is(':checked'),
      is_active: $('#edit-active').is(':checked'),
      expires_at: $('#edit-expires').val() || null
    };

    $.ajax({
      url: '/api/admin/announcements/' + id,
      method: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function() {
        $('#editAnnouncementModal').modal('hide');
        loadAnnouncements();
      },
      error: function(xhr) {
        alert('Error saving announcement: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
      }
    });
  });

  // Confirm delete
  $('#confirm-delete-btn').click(function() {
    var id = $('#delete-id').val();
    $.ajax({
      url: '/api/admin/announcements/' + id,
      method: 'DELETE',
      success: function() {
        $('#deleteAnnouncementModal').modal('hide');
        loadAnnouncements();
      },
      error: function(xhr) {
        alert('Error deleting announcement: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
      }
    });
  });
});
</script>
{% endblock %}
