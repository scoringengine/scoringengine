{% extends 'base.html' %}
{% block title %}Services{% endblock %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block content %}
<div class="page-wrap">
    <div class="stat-cards-row">
        <div class="stat-card">
            <div class="stat-label">Team</div>
            <div class="stat-value" id="team_name" style="font-size:1.5rem">{{ current_user.team.name }}</div>
            <div class="stat-detail" id="team_color_bar">&nbsp;</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Place</div>
            <div class="stat-value" id="team_place">-</div>
            <div class="stat-detail">current rank</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Score</div>
            <div class="stat-value" id="team_current_score">-</div>
            <div class="stat-detail">total points</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Services Up</div>
            <div class="stat-value text-success" id="services_up">-</div>
            <div class="stat-detail">this round</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Services Down</div>
            <div class="stat-value text-danger" id="services_down">-</div>
            <div class="stat-detail">this round</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Uptime</div>
            <div class="stat-value" id="overall_uptime">-</div>
            <div class="stat-detail">overall</div>
        </div>
    </div>

    <h3 class="section-header">Services</h3>
    <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="services" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th><div title="Name of Service">Service</div></th>
                    <th><div title="Host/ip of the service">Host</div></th>
                    <th><div title="Port of the service">Port</div></th>
                    <th><div title="Current check result of the service">Status</div></th>
                    <th><div title="Overall rank compared to other blue teams">Rank</div></th>
                    <th><div title="Overall score earned for this service">Score Earned</div></th>
                    <th><div title="Maximum possible score">Max Score</div></th>
                    <th><div title="Percent of overall score earned">% Earned</div></th>
                    <th><div title="Points per successful check">Pts Per Check</div></th>
                    <th><div title="Last 10 results">Trending</div></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
            function refreshteamdata() {
                $.ajax({
                    cache: false,
                    url: '/api/team/{{ current_user.team.id }}/stats',
                    dataType: 'json',
                    success: function(data) {
                        ScoringEngineUtils.animateCounter(document.getElementById('team_place'), parseInt(data.place) || 0);
                        ScoringEngineUtils.animateCounter(document.getElementById('team_current_score'), parseFloat(data.current_score) || 0);
                    }
                });
            }

            function updateHealthSummary(data) {
                var servicesUp = 0;
                var servicesDown = 0;
                var totalEarned = 0;
                var totalMax = 0;

                if (data && data.data) {
                    data.data.forEach(function(service) {
                        if (service.check === "UP") {
                            servicesUp++;
                        } else if (service.check === "DOWN") {
                            servicesDown++;
                        }
                        totalEarned += parseFloat(service.score_earned) || 0;
                        totalMax += parseFloat(service.max_score) || 0;
                    });
                }

                ScoringEngineUtils.animateCounter(document.getElementById('services_up'), servicesUp);
                ScoringEngineUtils.animateCounter(document.getElementById('services_down'), servicesDown);

                var uptime = totalMax > 0 ? ((totalEarned / totalMax) * 100).toFixed(1) + '%' : '-';
                ScoringEngineUtils.setText(document.getElementById('overall_uptime'), uptime);
            }

            $(document).ready(function() {
                refreshteamdata();
                setInterval(function(){
                    refreshteamdata()
                }, 30000);

                // Disable datatables error reporting
                $.fn.dataTable.ext.errMode = 'none';

                var table = $('#services')
                    .on('error.dt', function (e, settings, techNote, message) {
                        console.log('An error has been reported by DataTables: ', message);
                    })
                    .DataTable({
                        'paging': false,
                        'bFilter': false,
                        'bInfo': false,
                        "ajax": {
                            "url": "/api/team/{{ current_user.team.id }}/services",
                            "dataSrc": function(json) {
                                updateHealthSummary(json);
                                return json.data;
                            }
                        },
                        "order": [],
                        "columns": [
                            {
                                "data": null,
                                "render": function( data ) {
                                    return '<a href="/service/' + data.service_id + '">' + data.service_name + '</a>';
                                }
                            },
                            { "data": "host" },
                            { "data": "port" },
                            {
                                "data": null,
                                "render": function( data ) {
                                    var span_str = '<span class="badge bg-'
                                    var label_level = 'secondary'
                                    var label_str = 'Undetermined'
                                    if ( data.check == "UP" ) {
                                        label_level = 'success'
                                        label_str = 'UP'
                                    } else if ( data.check == "DOWN" ) {
                                        label_level = 'danger'
                                        label_str = 'DOWN'
                                    }
                                    span_str += label_level + '">' + label_str + '</span>'
                                    return span_str;
                                }
                            },
                            { "data": "rank" },
                            {
                                "data": "score_earned",
                                "render": function( data ) {
                                    return parseFloat(data).toLocaleString()
                                }
                            },
                            {
                                "data": "max_score",
                                "render": function( data ) {
                                    return parseFloat(data).toLocaleString()
                                }
                            },
                            { "data": "percent_earned" },
                            { "data": "pts_per_check" },
                            {
                                "data": null,
                                "orderable": false,
                                "render": function( data ) {
                                    var last_ten_checks = '<div align="right">'
                                    for (var index in data.last_ten_checks) {
                                        if ( data.last_ten_checks[index] == true ) {
                                            last_ten_checks += '<i class="bi bi-check-lg" style="color:green"></i>';
                                        }
                                        else {
                                        last_ten_checks += '<i class="bi bi-x-lg" style="color:red"></i>';
                                        }
                                    }
                                    return '</div>' + last_ten_checks;
                                }
                            },
                        ],
                    });
                setInterval( function () {
                    table.ajax.reload();
                }, 30000 );
            } );
    </script>
</div>
{% endblock %}
