{% extends 'base.html' %}
{% block title %}Overview{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap.min.css') }}" />
{% endblock %}
{% block content %}
<div class="container-fluid md-page">
    <div class="row">
        <h2 id="round_number" class="text-center"></h2>
        <h4 id="round_start" class="text-center"></h4>
    </div>
    <div class="row">
        <table id="overview" class="table table-striped table-bordered table-compact" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th></th>
                    {% for team in teams %}
                    <th>{{ team.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
        </table>
        <div id='hint'>Hover over status icon to get host:port information</div>
        <div id='overview_api_reference'>Want a json formatted version of this data (including ip addresses)? <a
                href="{{ url_for('api.overview_data') }}">Here</a></div>
        <script>
            function refreshheader() {
                $.ajax({
                    cache: false,
                    url: '/api/overview/get_round_data',
                    dataType: 'json',
                    success: function (data) {
                        $('#round_number').text("Round " + data.number);
                        $('#round_start').text(data.round_start);
                    }
                });
            }

            // Populate services table
            var overview = $('#overview').DataTable({
                'ajax': '/api/overview/get_data',
                'paging': false,
                'bSort': false,
                'info': false,
                'searching': false,
                'scrollX': true,
                'columnDefs': [
                    { "width": "10%", "targets": 0 }
                ],
                'createdRow': function (row, data, index) {
                    // Cache row cells array for better performance
                    var $cells = $(row).children('td');
                    var cellsLength = $cells.length;
                    // Get row label from first cell to determine row type
                    var rowLabel = data[0];

                    // Process cells
                    for (var i = 0; i < cellsLength; i++) {
                        var $cell = $($cells[i]);
                        var value = $cell.html();

                        // Determine row type by label instead of index
                        if (rowLabel === 'Current Score') {
                            if (i == 0) {
                                $cell.html(`<span style="font-weight:bold">${value}</span>`);
                            } else {
                                $cell.html(parseFloat(value).toLocaleString());
                            }
                        } else if (rowLabel === 'Current Place') {
                            if (i == 0) {
                                $cell.html(`<span style="font-weight:bold">${value}</span>`);
                            } else {
                                // Add medal ribbons for top 3
                                var medal = '';
                                if (value == 1) medal = ' <i class="glyphicon glyphicon-tags" style="color: #C98910"></i>';
                                else if (value == 2) medal = ' <i class="glyphicon glyphicon-tags" style="color: #A8A8A8"></i>';
                                else if (value == 3) medal = ' <i class="glyphicon glyphicon-tags" style="color: #965A38"></i>';
                                if (medal) $cell.html(value + medal);
                            }
                        } else if (rowLabel === 'SLA Penalties') {
                            // SLA Penalties row - just bold the label
                            if (i == 0) {
                                $cell.html(`<span style="font-weight:bold">${value}</span>`);
                            }
                            // Leave penalty values as-is (already formatted with HTML from API)
                        } else if (rowLabel === 'Up/Down Ratio') {
                            // Up/Down Ratio row - just bold the label
                            if (i == 0) {
                                $cell.html(`<span style="font-weight:bold">${value}</span>`);
                            }
                            // Leave ratio values as-is (already formatted with HTML from API)
                        } else {
                            // Service status row
                            if (i == 0) {
                                $cell.html(`<span style="font-weight:bold">${value}</span>`);
                            } else {
                                // Determine status icon and color
                                var icon, color;
                                if (value == 'true') {
                                    icon = 'glyphicon-ok';
                                    color = 'green';
                                } else if (value == 'false') {
                                    icon = 'glyphicon-remove';
                                    color = 'red';
                                } else {
                                    icon = 'glyphicon-question-sign';
                                    color = 'black';
                                }
                                $cell.html(`<span class="glyphicon ${icon}" style="color:${color}"></span>`);
                            }
                        }
                    }
                }
            });

            $(document).ready(function () {
                // Disable datatables error reporting
                $.fn.dataTable.ext.errMode = 'none';

                // Populate our header
                refreshheader();
                setInterval(function () {
                    refreshheader()
                }, 30000);

                setInterval(function () {
                    overview.ajax.reload();
                }, 30000);
            });
        </script>
    </div>
</div>
{% endblock %}