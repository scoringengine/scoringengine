{% extends 'base.html' %}
{% block title %}Inject{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
<!-- Dropzone -->
<script src="{{ url_for('static', filename='vendor/js/dropzone.min.js') }}"></script>
<link href="{{ url_for('static', filename='vendor/css/dropzone.min.css') }}" rel="stylesheet" />
<!-- Moment -->
<script src="{{ url_for('static', filename='vendor/js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/moment-timezone.min.js') }}"></script>
<!-- Markdown -->
<script src="{{ url_for('static', filename='vendor/js/marked.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="page-wrap">
  <div class="row">
    <div class="col-sm-3 lefthand-nav" style="padding-top: 4px;">
      <div id="inject_navbar" class="list-group"></div>
    </div>
    <div class="col-sm-9">
      <!-- Title & action button (populated by JS) -->
      <div id="inject-header"></div>

      <!-- Metadata -->
      <div id="inject-meta"></div>

      <!-- Scenario -->
      <div id="scenario-section"></div>

      <!-- Deliverable -->
      <div id="deliverable-section"></div>

      <!-- Rubric -->
      <div id="rubric-section"></div>

      <!-- File Upload -->
      <div id="upload-section"></div>

      <!-- Files -->
      <h3 class="section-header">Files</h3>
      <div id="files"></div>

      <!-- Comments -->
      <h3 class="section-header">Comments</h3>
      <div id="comments"></div>
      <div class="chart-card" style="padding:1rem 1.25rem;">
        <form>
          <div class="mb-3">
            <textarea id="commentArea" class="form-control" rows="3" maxlength="25000" placeholder="Write a comment..."></textarea>
            <div class="form-text text-end"><span id="commentCharCount">0</span> / 25,000</div>
          </div>
          <button id="addCommentButton" type="button" class="btn btn-primary">Comment</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Submit Modal -->
<div class="modal fade" id="submitInjectConfirmation" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submit Inject</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to submit this inject?</p>
        <p><b>You will not be able to edit this inject after submitting.</b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="injectSubmitConfirmButton" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>
<!-- Resubmit Modal -->
<div class="modal fade" id="resubmitInjectConfirmation" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Resubmit Inject</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to resubmit this inject?</p>
        <p><b>You will not be able to edit this inject after resubmitting.</b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="injectResubmitConfirmButton" class="btn btn-primary">Resubmit</button>
      </div>
    </div>
  </div>
</div>
<!-- File Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalTitle">Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
  var INJECT_ID = {{ inject_id }};
  var TEAM_NAME = "{{ current_user.team.name }}";

  $(document).ready(function () {
    // Load inject detail (populates header, meta, scenario, deliverable, rubric)
    loadInjectDetail();

    // Load navbar and update every 30 seconds
    updateInjects();
    setInterval(updateInjects, 30000);

    // Load comments and update every 30 seconds
    updateComments();
    setInterval(updateComments, 30000);

    // Load files and update every 30 seconds
    updateFiles();
    setInterval(updateFiles, 30000);
  });

  function loadInjectDetail() {
    $.ajax({
      url: "/api/inject/" + INJECT_ID,
      success: function (r) {
        // --- Header ---
        var headerHtml = '<div class="d-flex justify-content-between align-items-start mb-3"><div>';
        headerHtml += '<h3 class="page-title mb-1">' + $('<span>').text(r.title).html() + '</h3>';
        if (r.status == 'Submitted' || r.status == 'Resubmitted') {
          headerHtml += '<span class="badge bg-success">' + r.status + '</span>';
        } else if (r.status == 'Graded') {
          headerHtml += '<span class="badge bg-info text-white">' + r.status + '</span>';
        } else if (r.expired && r.status == 'Draft') {
          headerHtml += '<span class="badge bg-danger">Expired</span>';
        } else if (r.status == 'Revision Requested') {
          headerHtml += '<span class="badge bg-warning text-dark">' + r.status + '</span>';
        } else if (r.status == 'Draft') {
          headerHtml += '<span class="badge bg-warning text-dark">' + r.status + '</span>';
        }
        headerHtml += '</div>';
        if (r.status == 'Draft' && !r.expired) {
          headerHtml += '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitInjectConfirmation">Submit Inject</button>';
        } else if (r.status == 'Revision Requested') {
          headerHtml += '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#resubmitInjectConfirmation">Resubmit Inject</button>';
        }
        headerHtml += '</div>';
        $('#inject-header').html(headerHtml);

        // --- Metadata ---
        var startTime = r.start_time ? moment.utc(r.start_time).tz(moment.tz.guess()) : null;
        var endTime = r.end_time ? moment.utc(r.end_time).tz(moment.tz.guess()) : null;
        var metaHtml = '<div class="chart-card mb-3" style="padding:0; overflow:hidden;"><table class="table table-sm mb-0"><tbody>';
        metaHtml += '<tr><td style="width:120px;"><strong>Points</strong></td><td>';
        if (r.scores_visible && r.score !== null) {
          metaHtml += r.score + ' / ';
        }
        metaHtml += r.max_score + '</td></tr>';
        if (startTime) {
          metaHtml += '<tr><td><strong>Start Time</strong></td><td>' + startTime.format('YYYY-MM-DD HH:mm:ss z') + ' (' + startTime.fromNow() + ')</td></tr>';
        }
        if (endTime) {
          metaHtml += '<tr><td><strong>End Time</strong></td><td>' + endTime.format('YYYY-MM-DD HH:mm:ss z') + ' (' + endTime.fromNow() + ')</td></tr>';
        }
        metaHtml += '</tbody></table></div>';
        $('#inject-meta').html(metaHtml);

        // --- Scenario ---
        if (r.scenario) {
          var scenarioHtml = '<h3 class="section-header">Scenario</h3>';
          scenarioHtml += '<div class="chart-card mb-3" style="padding:1rem 1.25rem;">';
          scenarioHtml += '<div>' + marked.parse(r.scenario) + '</div></div>';
          $('#scenario-section').html(scenarioHtml);
        }

        // --- Deliverable ---
        if (r.deliverable) {
          var deliverableHtml = '<h3 class="section-header">Deliverable</h3>';
          deliverableHtml += '<div class="chart-card mb-3" style="padding:1rem 1.25rem;">';
          deliverableHtml += '<div>' + marked.parse(r.deliverable) + '</div></div>';
          $('#deliverable-section').html(deliverableHtml);
        }

        // --- Rubric ---
        if (r.rubric_items && r.rubric_items.length > 0) {
          var showScores = r.scores_visible && r.status === 'Graded';
          var rubricHtml = '<h3 class="section-header">Rubric</h3>';
          rubricHtml += '<div class="chart-card mb-3" style="padding:0; overflow:hidden;">';
          rubricHtml += '<table class="table table-sm mb-0"><thead><tr>';
          rubricHtml += '<th style="padding:0.5rem 1rem;">Item</th>';
          rubricHtml += '<th style="padding:0.5rem 1rem;">Description</th>';
          rubricHtml += '<th style="padding:0.5rem 1rem;">Points</th>';
          if (showScores) rubricHtml += '<th style="padding:0.5rem 1rem;">Score</th>';
          rubricHtml += '</tr></thead><tbody>';
          var scoreMap = {};
          if (r.rubric_scores) {
            $.each(r.rubric_scores, function(i, rs) { scoreMap[rs.rubric_item_id] = rs.score; });
          }
          $.each(r.rubric_items, function(i, item) {
            rubricHtml += '<tr><td style="padding:0.5rem 1rem;">' + item.title + '</td>';
            rubricHtml += '<td style="padding:0.5rem 1rem;">' + (item.description || '') + '</td>';
            rubricHtml += '<td style="padding:0.5rem 1rem;">' + item.points + '</td>';
            if (showScores) {
              rubricHtml += '<td style="padding:0.5rem 1rem;">' + (scoreMap[item.id] !== undefined ? scoreMap[item.id] : '-') + '</td>';
            }
            rubricHtml += '</tr>';
          });
          rubricHtml += '</tbody></table></div>';
          $('#rubric-section').html(rubricHtml);
        }

        // --- Upload section (only for editable statuses) ---
        if (r.status === 'Draft' || r.status === 'Revision Requested') {
          if (!r.expired) {
            var uploadHtml = '<h3 class="section-header">Upload Files</h3>';
            uploadHtml += '<form class="dropzone mb-3" id="file-upload"></form>';
            $('#upload-section').html(uploadHtml);
            initDropzone();
          }
        }

        // Store status for file delete logic
        window.injectStatus = r.status;
        window.injectExpired = r.expired;
      }
    });
  }

  function initDropzone() {
    if (document.getElementById('file-upload')) {
      new Dropzone('#file-upload', {
        url: '/api/inject/' + INJECT_ID + '/upload',
        init: function () {
          this.on("success", function(file) {
            console.log("File uploaded successfully");
            updateFiles();
          });
          this.on("error", function(file) {
            console.error("Error uploading file");
          });
        }
      });
    }
  }
</script>
<script>
  // Submit Inject Confirmation
  $('#injectSubmitConfirmButton').unbind().click(function () {
    $.ajax({
      url: "/api/inject/" + INJECT_ID + "/submit",
      type: 'POST',
      success: function (result) {
        bootstrap.Modal.getInstance(document.getElementById('submitInjectConfirmation')).hide();
        location.reload();
      },
      error: function (result) {
        console.error(result['responseJSON']['status']);
      }
    });
  });

  // Resubmit Inject Confirmation
  $('#injectResubmitConfirmButton').unbind().click(function () {
    $.ajax({
      url: "/api/inject/" + INJECT_ID + "/resubmit",
      type: 'POST',
      success: function (result) {
        bootstrap.Modal.getInstance(document.getElementById('resubmitInjectConfirmation')).hide();
        location.reload();
      },
      error: function (result) {
        console.error(result['responseJSON']['status']);
      }
    });
  });
</script>
<script>
  function updateInjects() {
    $.ajax({
      url: "/api/injects",
      success: function (result) {
        var navbar = "";
        $.each(result.data, function (index, value) {
          navbar += '<a href="/inject/' + value.id + '" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          if (window.location.pathname == "/inject/" + value.id) {
            navbar += ' active';
          }
          navbar += '">' + value.title + ' ';
          var currentTime = new Date();
          var endTime = new Date(value.end_time);
          if (value.status == "Graded") {
            navbar += '<span class="badge bg-info">Graded</span>';
          } else if (value.status == "Submitted" || value.status == "Resubmitted") {
            navbar += '<span class="badge bg-success">Submitted</span>';
          } else if (value.status == "Revision Requested") {
            navbar += '<span class="badge bg-warning text-dark">Revision</span>';
          } else if (currentTime > endTime) {
            navbar += '<span class="badge bg-danger">Expired</span>';
          } else {
            navbar += '<span class="badge bg-warning text-dark">Draft</span>';
          }
          navbar += '</a>';
        });
        $("#inject_navbar").html(navbar);
      },
      error: function (result) {
        console.error("Error loading injects");
      }
    });
  };
</script>
<script>
  var previewableExtensions = ['.pdf', '.txt', '.docx', '.odt', '.png', '.jpg', '.jpeg', '.gif', '.svg'];
  var imageExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.svg'];

  function getFileExtension(filename) {
    return filename.substring(filename.lastIndexOf('.')).toLowerCase();
  }

  function isPreviewable(filename) {
    return previewableExtensions.indexOf(getFileExtension(filename)) !== -1;
  }

  function previewFile(fileId, filename) {
    var ext = getFileExtension(filename);
    var previewUrl = '/api/inject/' + INJECT_ID + '/files/' + fileId + '/preview';
    if (ext === '.pdf') {
      $('#previewModalBody').html('<iframe src="' + previewUrl + '" style="width:100%;height:80vh;border:none;"></iframe>');
      $('#previewModalTitle').text('Preview: ' + filename);
      new bootstrap.Modal(document.getElementById('previewModal')).show();
    } else if (imageExtensions.indexOf(ext) !== -1) {
      $('#previewModalBody').html('<img src="' + previewUrl + '" class="img-fluid" alt="' + filename + '">');
      $('#previewModalTitle').text('Preview: ' + filename);
      new bootstrap.Modal(document.getElementById('previewModal')).show();
    } else if (ext === '.odt' || ext === '.docx') {
      $('#previewModalBody').html('<iframe src="' + previewUrl + '" style="width:100%;height:80vh;border:none;background:#fff;"></iframe>');
      $('#previewModalTitle').text('Preview: ' + filename);
      new bootstrap.Modal(document.getElementById('previewModal')).show();
    } else {
      $.ajax({
        url: previewUrl,
        success: function (result) {
          if (ext === '.txt') {
            $('#previewModalBody').html('<pre>' + $('<div>').text(result).html() + '</pre>');
          } else {
            $('#previewModalBody').html(result);
          }
          $('#previewModalTitle').text('Preview: ' + filename);
          new bootstrap.Modal(document.getElementById('previewModal')).show();
        },
        error: function () {
          alert('Error loading preview');
        }
      });
    }
  }

  function updateFiles() {
    var canDelete = (window.injectStatus === 'Draft' || window.injectStatus === 'Revision Requested') && !window.injectExpired;
    $.ajax({
      url: "/api/inject/" + INJECT_ID + "/files",
      success: function (result) {
        var files = '';
        $.each(result.data, function (index, value) {
          files += "<p><a href='/api/inject/" + INJECT_ID + "/files/" + value.id + "/download'>" + value.name + "</a>";
          if (isPreviewable(value.name)) {
            files += ' <button class="btn btn-sm btn-info" onclick="previewFile(' + value.id + ', \'' + value.name.replace(/'/g, "\\'") + '\')">Preview</button>';
          }
          if (canDelete) {
            files += ' <button class="btn btn-sm btn-danger delete-file-btn" data-file-id="' + value.id + '">Delete</button>';
          }
          files += "</p>";
        });
        $("#files").html(files);

        if (canDelete) {
          $('.delete-file-btn').on('click', function() {
            var fileId = $(this).data('file-id');
            if (confirm('Are you sure you want to delete this file?')) {
              $.ajax({
                url: "/api/inject/" + INJECT_ID + "/files/" + fileId,
                type: 'DELETE',
                success: function() { updateFiles(); },
                error: function() { alert('Error deleting file'); }
              });
            }
          });
        }
      },
      error: function () {
        console.error("Error loading files");
      }
    });
  };
</script>
<script>
  // Disable Dropzone auto-discover since we init manually
  Dropzone.autoDiscover = false;
</script>
<script>
  function updateComments() {
    $.ajax({
      url: "/api/inject/" + INJECT_ID + "/comments",
      success: function (result) {
        var comments = "";
        $.each(result.data, function (index, value) {
          var isOwn = value.team == TEAM_NAME;
          comments += '<div class="chart-card mb-2" style="padding:0; overflow:hidden;">' +
            '<div style="padding:0.5rem 1rem; font-size:0.85rem; color:var(--bs-secondary-color);' + (isOwn ? ' border-left:3px solid #58a6ff;' : '') + '">' +
            '<strong>' + value.user + '</strong> <span class="text-muted">(' + value.team + ')</span> &middot; ' + value.added + '</div>' +
            '<div style="padding:0.75rem 1rem;">' + value.text + '</div></div>';
        });
        $("#comments").html(comments);
      },
      error: function () {
        console.error("Error loading comments");
      }
    });
  };
</script>
<script>
  $('#commentArea').on('input', function () {
    var len = $(this).val().length;
    $('#commentCharCount').text(len.toLocaleString());
    if (len >= 25000) {
      $('#commentCharCount').parent().removeClass('text-warning').addClass('text-danger');
    } else if (len >= 20000) {
      $('#commentCharCount').parent().removeClass('text-danger').addClass('text-warning');
    } else {
      $('#commentCharCount').parent().removeClass('text-danger text-warning');
    }
  });

  $('#addCommentButton').unbind().click(function () {
    $.ajax({
      url: "/api/inject/" + INJECT_ID + "/comment",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        comment: $('#commentArea').val()
      }),
      success: function (result) {
        $('#commentArea').val('');
        $('#commentCharCount').text('0');
        $('#commentCharCount').parent().removeClass('text-danger text-warning');
        updateComments();
      },
      error: function (result) {
        alert(result.responseJSON['status']);
        console.error("ERROR:", result.responseJSON['status']);
      }
    });
  });
</script>
{% endblock %}
