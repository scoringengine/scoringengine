{% extends 'base.html' %}
{% block title %}Service{% endblock %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='vendor/js/dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap5.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap5.min.css') }}" />
{% endblock %}
{% block content %}
<div class="container-fluid" style="max-width:1400px; margin-top:16px;">
  <div class="row">
    <div class="col-sm-3 lefthand-nav" style="padding-top: 4px;">
      <div id="service_navbar" class="list-group">
      </div>
    </div>
    <div class="col-sm-9">
      <div class="stat-cards-row">
        <div class="stat-card" style="flex: 2 1 0;">
          <div class="stat-label">Service</div>
          <div class="stat-value" style="font-size:1.5rem">{{service.name}}</div>
          <div class="stat-detail">{{service.host}}:{{service.port}}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Host</div>
          {% if modify_hostname_setting %}
          <input type="text" class="form-control form-control-sm editable-field text-center"
                 data-pk="{{service.id}}" data-name="host"
                 data-url="{{url_for('api.update_host')}}"
                 value="{{service.host}}">
          {% else %}
          <div class="stat-value" style="font-size:1rem">{{service.host}}</div>
          {% endif %}
        </div>
        <div class="stat-card">
          <div class="stat-label">Port</div>
          {% if modify_port_setting %}
          <input type="text" class="form-control form-control-sm editable-field text-center"
                 data-pk="{{service.id}}" data-name="port"
                 data-url="{{url_for('api.update_port')}}"
                 value="{{service.port}}">
          {% else %}
          <div class="stat-value">{{service.port}}</div>
          {% endif %}
        </div>
      </div>

      {% if service.accounts %}
      <h3 class="section-header">Accounts</h3>
      <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table class="table table-striped table-bordered table-sm">
          <thead>
            <tr>
              <th style="width: 30%">Username</th>
              <th>Password</th>
            </tr>
          </thead>
          <tbody>
            {% for account in service.accounts %}
            <tr>
              <td>
                {% if modify_account_usernames_setting %}
                <input type="text" class="form-control form-control-sm editable-field"
                       data-pk="{{account.id}}" data-name="username"
                       data-url="{{url_for('api.update_service_account_info')}}"
                       value="{{account.username}}">
                {% else %}
                <span class="form-control-plaintext">{{account.username}}</span>
                {% endif %}
              </td>
              <td>
                {% if modify_account_passwords_setting %}
                <div class="input-group">
                  <input type="password" class="form-control form-control-sm editable-field password-field"
                         data-pk="{{account.id}}" data-name="password"
                         data-url="{{url_for('api.update_service_account_info')}}"
                         value="{{account.password}}">
                  <button class="btn btn-outline-secondary btn-sm toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {% else %}
                <div class="input-group">
                  <input type="password" class="form-control form-control-sm password-field"
                         value="{{account.password}}" disabled>
                  <button class="btn btn-outline-secondary btn-sm toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <h3 class="section-header">Checks</h3>
      <div class="chart-card" style="padding:1rem 1.25rem; overflow:hidden;">
        <table id="checks" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th></th>
              <th>Round</th>
              <th>Result</th>
              <th>Earned</th>
              <th>Reason</th>
              <th>Timestamp</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    // Auto-save editable fields on blur
    $('.editable-field').on('change', function() {
      var $input = $(this);
      var originalValue = $input.data('original-value');
      var newValue = $input.val().trim();

      // Don't save if value hasn't changed
      if (newValue === originalValue) return;

      var pk = $input.data('pk');
      var name = $input.data('name');
      var url = $input.data('url');

      // Show saving indicator
      $input.addClass('is-loading');

      $.ajax({
        url: url,
        type: 'POST',
        data: {
          pk: pk,
          name: name,
          value: newValue
        },
        success: function(response) {
          $input.removeClass('is-loading');
          if (response.error) {
            $input.addClass('is-invalid');
            alert('Error: ' + response.error);
            $input.val(originalValue);  // Restore original value
          } else {
            $input.removeClass('is-invalid').addClass('is-valid');
            $input.data('original-value', newValue);  // Update stored value
            setTimeout(function() {
              $input.removeClass('is-valid');
            }, 2000);
          }
        },
        error: function(xhr) {
          $input.removeClass('is-loading').addClass('is-invalid');
          var msg = 'Error saving';
          try {
            msg = xhr.responseJSON.error || xhr.responseJSON.status || msg;
          } catch(e) {}
          alert(msg);
          $input.val(originalValue);  // Restore original value
        }
      });
    });

    // Store original values on page load
    $('.editable-field').each(function() {
      $(this).data('original-value', $(this).val());
    });

    // Toggle password visibility
    $('.toggle-password').on('click', function() {
      var $btn = $(this);
      var $input = $btn.closest('.input-group').find('input');
      var $icon = $btn.find('i');

      if ($input.attr('type') === 'password') {
        $input.attr('type', 'text');
        $icon.removeClass('bi-eye').addClass('bi-eye-slash');
      } else {
        $input.attr('type', 'password');
        $icon.removeClass('bi-eye-slash').addClass('bi-eye');
      }
    });

    // Services navbar
    function refreshServicesNavbar() {
      $.ajax({
        cache: false,
        url: "/api/team/{{service.team.id}}/services/status",
        dataType: 'json',
        success: function(data) {
          var navbar_str = "";
          for (var key in data) {
            var value = data[key];
            var navbar_row_str = '<a href="/service/' + value['id'] + '" class="list-group-item';
            if ("{{service.id}}" == value['id']) {
              navbar_row_str += " active";
            }
            navbar_row_str += '">' + key;
            if (value['result'] == 'True') {
              navbar_row_str += '<span class="float-end badge bg-success" style="margin-top: 2px;">UP</span>';
            } else if (value['result'] == 'False') {
              navbar_row_str += '<span class="float-end badge bg-danger" style="margin-top: 2px;">DOWN</span>';
            }
            navbar_row_str += "</a>";
            navbar_str += navbar_row_str;
          }
          $('div#service_navbar').html(navbar_str);
        }
      });
    }

    refreshServicesNavbar();

    // Disable datatables error reporting
    $.fn.dataTable.ext.errMode = 'none';

    var table = $('#checks')
      .on('error.dt', function(e, settings, techNote, message) {
        console.log('An error has been reported by DataTables: ', message);
      })
      .DataTable({
        "ajax": {
          "url": "/api/service/{{ id }}/checks",
          "type": 'GET'
        },
        "columns": [
          {
            "width": 15,
            "orderable": false,
            "data": null,
            "render": function(data) {
              var button_icon = 'bi-plus-lg';
              if (window.expanded_rows && window.expanded_rows.indexOf(data['round']) >= 0) {
                button_icon = 'bi-dash-lg';
              }
              return '<a class="expand-button"><i id="span_' + data['round'] + '" class="float-end bi ' + button_icon + '"></i></a>';
            }
          },
          { "data": "round" },
          {
            "data": "result",
            "render": function(data) {
              return data ? '<span class="badge bg-success">UP</span>' : '<span class="badge bg-danger">DOWN</span>';
            }
          },
          {
            "data": "earned_score",
            "render": function(data, type, row) {
              var modifierText = '';
              if (row.multiplier != 1.0) {
                modifierText += ' <small class="text-muted">(' + row.multiplier + 'x)</small>';
              }
              if (row.sla_penalty > 0) {
                modifierText += ' <small class="text-danger">(-' + row.sla_penalty + '%)</small>';
              }
              return data + modifierText;
            }
          },
          { "data": "reason" },
          { "data": "timestamp" }
        ],
        'order': [[1, 'desc']],
      });

    // Expand/collapse check output
    $('#checks tbody').on('click', 'a.expand-button', function() {
      var tr = $(this).closest('tr');
      var row = table.row(tr);

      if (!window.expanded_rows) {
        window.expanded_rows = [];
      }
      var round_num = row.data().round;

      if (window.expanded_rows.indexOf(round_num) == -1) {
        window.expanded_rows.push(round_num);
      } else {
        var index = window.expanded_rows.indexOf(round_num);
        if (index > -1) {
          window.expanded_rows.splice(index, 1);
        }
      }

      var icon_span = $(tr).find('i:first');
      if (row.child.isShown()) {
        row.child.hide();
        icon_span.removeClass('bi-dash-lg').addClass('bi-plus-lg');
      } else {
        var output_row = '<pre style="max-height: 350px;">' + row.data().output + '</pre>';
        row.child(output_row).show();
        icon_span.removeClass('bi-plus-lg').addClass('bi-dash-lg');
      }
    });

    // Expands previously expanded rows on datatables reload
    function expandRows(data) {
      if (window.expanded_rows) {
        for (var i = 0; i < window.expanded_rows.length; i++) {
          var key = window.expanded_rows[i];
          table.rows().every(function() {
            if (this.data()['round'] == key) {
              var row = table.row(this);
              var output_row = '<pre>' + row.data().output + '</pre>';
              row.child(output_row).show();
              var icon_span = $(this.node()).find('i:first');
              icon_span.removeClass('bi-plus-lg').addClass('bi-dash-lg');
            }
          });
        }
      }
    }

    setInterval(function() {
      table.ajax.reload(expandRows, false);
      refreshServicesNavbar();
    }, 30000);
  });
</script>
{% endblock %}
