#!/usr/bin/env python

# A scoring engine check that connecs to SMB
# and tries to read a file and verifies the hash
#
# To install: pip install -I "pysmb>=1.1,<1.2"

import tempfile
import argparse
from smb.SMBConnection import SMBConnection
import hashlib


def check_smb(host, port, share_name, file_name, username, password, remote_name, hash_to_test):
    try:
        conn = SMBConnection(username, password, 'name', remote_name,
                             use_ntlm_v2=True, is_direct_tcp=True)
        conn.connect(host, int(port))
        shares = conn.listShares()

        for share in shares:
            if share.name.strip() == share_name:
                with tempfile.NamedTemporaryFile() as temp_file:
                    conn.retrieveFile(share.name, '/{}'.format(file_name), temp_file)
                    temp_file.seek(0)
                    data = temp_file.read()
                    hash_obj = hashlib.sha256(data)
                    if hash_obj.hexdigest() == hash_to_test:
                        print('SUCCESS')
                        return
    except Exception as e:
        print(str(e))
    print('Failed check')


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--host', help='ip to test', dest='host')
    parser.add_argument('--port', help='port to test', dest='port')
    parser.add_argument('--user', help='username', dest='user')
    parser.add_argument('--pass', help='password', dest='passw')
    parser.add_argument('--remote-name', help='remote_name', dest='remote_name')
    parser.add_argument('--share', help='share name', dest='share')
    parser.add_argument('--file', help='file name', dest='file')
    parser.add_argument('--hash', help='hash for comparison of file to endpoint', dest='hash')
    args = parser.parse_args()
    check_smb(args.host, args.port, args.share, args.file, args.user, args.passw, args.remote_name, args.hash)


if __name__ == '__main__':
    main()
