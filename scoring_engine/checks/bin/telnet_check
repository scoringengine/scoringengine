#!/usr/bin/env python

# A check that logs into a Telnet server and runs a command out of a series of
# commands. The check will log in to the Telnet server and run a single command
# for each command in the list.

import sys
from telnetlib import Telnet


# Parse arguments
if len(sys.argv) != 6:
    print('Usgae: ' + sys.argv[0] + ' host port username password commands')
    print("commands parameter supports multiple commands, use ';' as the delimiter")
    sys.exit(1)

host = sys.argv[1]
port = sys.argv[2]
username = sys.argv[3]
password = sys.argv[4]
commands = sys.argv[5].split(';')


def connect_and_execute(host, port, username, password, command):
    """
    A simple function that executes a command on a server via Telnet.

    Returns a tuple of the form (output, exception)
    """
    try:
        # Log in to the telnet server
        client = Telnet(host)

        # Send username
        client.read_until(b'login:')
        client.write(username.encode('ascii') + b'\n')

        # Send password
        client.read_until(b'Password:')
        client.write(password.encode('ascii') + b'\n')

        # Wait for shell
        output = client.read_until(b'$ ')

        # Run the command
        client.write(command.encode('ascii') + b'\n')
        output += client.read_until(b'$ ')

        # Log out
        client.write('exit\n'.encode('ascii'))
        output += client.read_all()

    except EOFError as e:
        return None, e

    return output, None


# Run all commands
last_command_output = ''
for command in commands:
    command_output, command_error = connect_and_execute(host, port, username, password, command)
    if command_error:
        print('ERROR: Command ran unsuccessfully: ' + str(command))
        print(command_error)
        sys.exit(1)
    last_command_output = command_output.rstrip()

print('SUCCESS')
print(last_command_output)
