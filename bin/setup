#!/usr/bin/env python
from datetime import datetime, timedelta
from random import choice, randint, sample

import optparse
import os
import sys

from scoring_engine.models.inject import Template, Inject
from scoring_engine.models.team import Team
from scoring_engine.models.service import Service
from scoring_engine.models.round import Round
from scoring_engine.models.check import Check
from scoring_engine.models.flag import Flag, Solve, Platform, FlagTypeEnum, Perm

from scoring_engine.models.notifications import Notification
from scoring_engine.models.setting import Setting
from scoring_engine.db import db, init_db, delete_db, verify_db_ready
from scoring_engine.config import config
from scoring_engine.competition import Competition
from scoring_engine.logger import logger
from scoring_engine.version import version
from scoring_engine.web import create_app
from scoring_engine.engine.basic_check import (
    CHECK_SUCCESS_TEXT,
    CHECK_FAILURE_TEXT,
    CHECK_TIMED_OUT_TEXT,
)

parser = optparse.OptionParser()
parser.add_option("--overwrite-db", action="store_true", default=False)
parser.add_option("--example", action="store_true", default=False)

options, arguments = parser.parse_args()

# Env overrides (docker compose / installer friendliness)
if os.environ.get("SCORINGENGINE_EXAMPLE", "").lower() == "true":
    options.overwrite_db = True
    options.example = True

if os.environ.get("SCORINGENGINE_OVERWRITE_DB", "").lower() == "true":
    options.overwrite_db = True  # force boolean

logger.info("Starting Setup v.{0}".format(version))

app = create_app()

with app.app_context():
    db_ready = verify_db_ready()

    # If DB already exists and we aren't overwriting, exit SUCCESS
    if db_ready and not options.overwrite_db:
        logger.info("Database already initialized; skipping setup. (use --overwrite-db to reset)")
        sys.exit(0)

    logger.info("Setting up DB")

    # Only wipe when explicitly requested and DB exists
    if options.overwrite_db and db_ready:
        logger.warning("Overwriting existing DB (--overwrite-db enabled)")
        delete_db()

    # Init tables (safe if empty / after delete)
    init_db()

    competition_config_file = os.path.join(os.path.dirname(os.path.abspath(__file__)), "competition.yaml")
    with open(competition_config_file, "r") as f:
        sample_competition_str = f.read()

    competition = Competition.parse_yaml_str(sample_competition_str)
    competition.save()

    about_content = """
<h4>Use the following credentials to login</h4>
<ul>
    <li>whiteteamuser:testpass</li>
    <li>redteamuser:testpass</li>
    <li>team1user1:testpass</li>
    <li>team2user1:testpass</li>
    <li>...</li>
    <li>team10user1:testpass</li>
</ul>"""

    welcome_content = """
<div class="row">
    <h1 class="text-center">Diamond Sponsors</h1>
</div>
<div class="row">
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
</div>
<div class="row">
    <h1 class="text-center">Platinum Sponsors</h1>
</div>
<div class="row">
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
</div>
<div class="row">
    <h1 class="text-center">Gold Sponsors</h1>
</div>
<div class="row">
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
    <div class="col-xs-12 col-md-4">
        <div class="card">
            <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
        </div>
    </div>
</div>
"""

    logger.info("Creating the default Settings")
    db.session.add(Setting(name="about_page_content", value=about_content))
    db.session.add(Setting(name="welcome_page_content", value=welcome_content))
    db.session.add(Setting(name="target_round_time", value=config.target_round_time))
    db.session.add(Setting(name="worker_refresh_time", value=config.worker_refresh_time))
    db.session.add(Setting(name="engine_paused", value=config.engine_paused))
    db.session.add(Setting(name="pause_duration", value=config.pause_duration))
    db.session.add(Setting(name="blue_team_update_hostname", value=config.blue_team_update_hostname))
    db.session.add(Setting(name="blue_team_update_port", value=config.blue_team_update_port))
    db.session.add(Setting(name="blue_team_update_account_usernames", value=config.blue_team_update_account_usernames))
    db.session.add(Setting(name="blue_team_update_account_passwords", value=config.blue_team_update_account_passwords))
    db.session.add(Setting(name="blue_team_view_check_output", value=config.blue_team_view_check_output))

    # Keep from master (visibility toggle)
    db.session.add(Setting(name="blue_team_view_status_page", value=config.blue_team_view_status_page))

    db.session.add(Setting(name="agent_checkin_interval_sec", value=config.target_round_time // 5))
    db.session.add(Setting(name="agent_show_flag_early_mins", value=config.agent_show_flag_early_mins))
    db.session.add(Setting(name="agent_psk", value=config.agent_psk))

    db.session.commit()

    if options.example:
        # Create AgentCheck services for flag capture status demo (matches repoâ€™s demo expectations)
        logger.info("Creating AgentCheck services for flag demo")
        agent_hosts = ["webserver", "database", "fileserver", "mailserver", "dns"]
        for team in Team.get_all_blue_teams():
            for i, host_name in enumerate(agent_hosts):
                agent_service = Service(
                    name=host_name.title(),
                    check_name="AgentCheck",
                    host=f"{host_name}.team{team.id}.local",
                    port=8080 + i,
                    points=50,
                    team=team,
                )
                db.session.add(agent_service)
        db.session.commit()

        # Simulate Rounds
        num_rounds = randint(200, 250)
        logger.info("Simulating " + str(num_rounds) + " rounds")
        for num_round in range(1, num_rounds + 1):
            round_obj = Round(
                number=num_round,
                round_start=datetime.now() - timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
                round_end=datetime.now() + timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
            )
            services = db.session.query(Service).all()
            for service in services:
                output = ""
                if randint(0, 1) == 1:
                    result = True
                    reason = CHECK_SUCCESS_TEXT
                    output = "Some random output of a command"
                else:
                    result = False
                    output = "Errored output"
                    reason = CHECK_FAILURE_TEXT if randint(0, 1) == 1 else CHECK_TIMED_OUT_TEXT

                command = "ping -c 1 127.0.0.1"
                check = Check(round=round_obj, service=service)
                check.finished(result, reason, output, command)
                db.session.add(check)
        db.session.commit()

        # Simulate Injects
        num_injects = randint(5, 15)
        logger.info("Simulating " + str(num_injects) + " Injects")
        for _ in range(num_injects):
            template = Template(
                title="Journey to Mordor",
                scenario="You have the ring, take it to be destroyed!",
                deliverable="Word document in at least 3 volumes with journalistic evidence of each step of your journey and the destruction of the ring.",
                score=100,
                start_time=datetime.now() - timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
                end_time=datetime.now() + timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
            )
            db.session.add(template)

            for team in Team.get_all_blue_teams():
                inject = Inject(team=team, template=template)
                inject.score = randint(0, 100)
                inject.status = choice(["Draft", "Submitted", "Graded"])
                db.session.add(inject)
            db.session.commit()

        # Simulate Notifications
        num_notifications = randint(50, 100)
        logger.info("Simulating " + str(num_notifications) + " Notifications")
        team_ids = [tid[0] for tid in db.session.query(Team.id).all()]
        for _ in range(num_notifications):
            notification = Notification(message="Test Notification", target="/admin/notifications")
            if randint(0, 1) == 1:
                notification.is_read = True
            notification.team_id = choice(team_ids)
            db.session.add(notification)
            db.session.commit()

        # Simulate Flags + Solves (use agent hosts so capture status works)
        num_flags = randint(10, 20)
        logger.info("Simulating " + str(num_flags) + " Flags")
        for i in range(num_flags):
            flag = Flag(
                start_time=datetime.now() - timedelta(hours=randint(1, 12)),
                end_time=datetime.now() + timedelta(hours=randint(24, 48)),
            )
            flag.platform = choice([Platform.nix, Platform.windows])
            flag.dummy = (i % 5 == 0)
            flag.type = choice([FlagTypeEnum.file, FlagTypeEnum.pipe, FlagTypeEnum.net, FlagTypeEnum.reg])
            flag.perm = choice([Perm.user, Perm.root])
            flag.data = {"path": f"/tmp/flag_{i}.txt", "content": f"FLAG_{i}_CONTENT"}
            db.session.add(flag)
            db.session.commit()

            for team_id in sample(team_ids, randint(1, len(team_ids))):
                host = f"{choice(agent_hosts)}.team{team_id}.local"
                solve = Solve(flag=flag, host=host, team_id=team_id)
                db.session.add(solve)
                db.session.commit()