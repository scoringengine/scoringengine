#!/usr/bin/env python
from datetime import datetime, timedelta
from random import choice, randint, sample

import optparse
import os

from scoring_engine.models.inject import Template, Inject
from scoring_engine.models.team import Team
from scoring_engine.models.service import Service
from scoring_engine.models.round import Round
from scoring_engine.models.check import Check
from scoring_engine.models.flag import Flag, Solve, FlagTypeEnum, Platform, Perm
from scoring_engine.models.agent import Agent

from scoring_engine.models.notifications import Notification
from scoring_engine.models.setting import Setting
from scoring_engine.db import db, init_db, delete_db, verify_db_ready
from scoring_engine.config import config
from scoring_engine.competition import Competition
from scoring_engine.logger import logger
from scoring_engine.version import version
from scoring_engine.web import create_app
from scoring_engine.engine.basic_check import (
    CHECK_SUCCESS_TEXT,
    CHECK_FAILURE_TEXT,
    CHECK_TIMED_OUT_TEXT,
)


parser = optparse.OptionParser()
parser.add_option("--overwrite-db", action="store_true", default=False)
parser.add_option("--example", action="store_true", default=False)

options, arguments = parser.parse_args()

# In order to handle docker-compose usability
# we have a check to see if the SCORINGENGINE_EXAMPLE environment
# variable is true. If it is, we want to populate
# the db with example data
if "SCORINGENGINE_EXAMPLE" in os.environ and os.environ["SCORINGENGINE_EXAMPLE"].lower() == "true":
    options.overwrite_db = True
    options.example = True

# If the SCORINGENGINE_OVERWRITE_DB environment variable is set
# we want to delete any previous data in the db
if "SCORINGENGINE_OVERWRITE_DB" in os.environ and os.environ["SCORINGENGINE_OVERWRITE_DB"].lower() == "true":
    options.overwrite_db = os.environ["SCORINGENGINE_OVERWRITE_DB"] == "true"

logger.info("Starting Setup v.{0}".format(version))

# Create Flask app for app context
app = create_app()

with app.app_context():
    if not options.overwrite_db:
        if verify_db_ready():
            logger.error("Exiting script and not overwriting db...must use --overwrite-db to overwrite data.")
            exit()
        else:
            # Database doesn't exist, so continuing on to setup script
            logger.debug("Database doesn't exist yet...")

    logger.info("Setting up DB")
    delete_db()
    init_db()

    competition_config_file = os.path.join(os.path.dirname(os.path.abspath(__file__)), "competition.yaml")
    sample_competition_str = open(competition_config_file, "r").read()
    competition = Competition.parse_yaml_str(sample_competition_str)
    competition.save()

    about_content = """
    <h4>Use the following credentials to login</h4>
    <ul>
        <li>whiteteamuser:testpass</li>
        <li>redteamuser:testpass</li>
        <li>team1user1:testpass</li>
        <li>team2user1:testpass</li>
        <li>...</li>
        <li>team10user1:testpass</li>
    </ul>"""

    welcome_content = """
    <div class="row">
        <h1 class="text-center">Diamond Sponsors</h1>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
    </div>
    <div class="row">
        <h1 class="text-center">Platinum Sponsors</h1>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
    </div>
    <div class="row">
        <h1 class="text-center">Gold Sponsors</h1>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
        <div class="col-xs-12 col-md-4">
            <div class="card">
                <img class='center-block' src="static/images/logo-placeholder.jpg" alt="sponsor image placeholder">
            </div>
        </div>
    </div>
    """

    logger.info("Creating the default Settings")
    db.session.add(Setting(name="about_page_content", value=about_content))
    db.session.add(Setting(name="welcome_page_content", value=welcome_content))
    db.session.add(Setting(name="target_round_time", value=config.target_round_time))
    db.session.add(Setting(name="worker_refresh_time", value=config.worker_refresh_time))
    db.session.add(Setting(name="engine_paused", value=config.engine_paused))
    db.session.add(Setting(name="pause_duration", value=config.pause_duration))
    db.session.add(Setting(name="blue_team_update_hostname", value=config.blue_team_update_hostname))
    db.session.add(Setting(name="blue_team_update_port", value=config.blue_team_update_port))
    db.session.add(Setting(name="blue_team_update_account_usernames", value=config.blue_team_update_account_usernames))
    db.session.add(Setting(name="blue_team_update_account_passwords", value=config.blue_team_update_account_passwords))
    db.session.add(Setting(name="blue_team_view_check_output", value=config.blue_team_view_check_output))
    db.session.add(Setting(name="agent_checkin_interval_sec", value=config.target_round_time // 5))
    db.session.add(Setting(name="agent_show_flag_early_mins", value=config.agent_show_flag_early_mins))
    db.session.add(Setting(name="agent_psk", value=config.agent_psk))
    db.session.commit()

    if options.example:
        # Simulate Rounds
        num_rounds = randint(200, 250)
        logger.info("Simulating " + str(num_rounds) + " rounds")
        for num_round in range(1, num_rounds + 1):
            round_obj = Round(
                number=num_round,
                round_start=datetime.now() - timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
                round_end=datetime.now() + timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
            )
            services = db.session.query(Service).all()
            for service in services:
                output = ""
                if randint(0, 1) == 1:
                    result = True
                    reason = CHECK_SUCCESS_TEXT
                    output = "Some random output of a command"
                else:
                    result = False
                    output = "Errored output"
                    if randint(0, 1) == 1:
                        reason = CHECK_FAILURE_TEXT
                    else:
                        reason = CHECK_TIMED_OUT_TEXT

                command = "ping -c 1 127.0.0.1"
                check = Check(round=round_obj, service=service)
                check.finished(result, reason, output, command)
                db.session.add(check)
        db.session.commit()

        # Simulate Injects
        num_injects = randint(5, 15)
        logger.info("Simulating " + str(num_injects) + " Injects")
        for _ in range(num_injects):
            template = Template(
                title="Journey to Mordor",
                scenario="You have the ring, take it to be destroyed!",
                deliverable="Word document in at least 3 volumes with journalistic evidence of each step of your journey and the destruction of the ring.",
                score=100,
                start_time=datetime.now() - timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
                end_time=datetime.now() + timedelta(hours=randint(0, 24), minutes=randint(0, 60)),
            )
            db.session.add(template)

            # rubric_0 = Rubric(
            #     deliverable="Damn hobbitses kept my precious!", value=0, template=template
            # )
            # rubric_50 = Rubric(
            #     deliverable="You gave it your best effort, but died along the way.",
            #     value=50,
            #     template=template,
            # )
            # rubric_100 = Rubric(
            #     deliverable="You saved the world!", value=100, template=template
            # )

            # db.session.add_all([template, rubric_0, rubric_50, rubric_100])

            for team in Team.get_all_blue_teams():
                inject = Inject(
                    team=team,
                    template=template,
                )
                inject.score = randint(0, 100)
                inject.status = choice(["Draft", "Submitted", "Graded"])
                db.session.add(inject)
            db.session.commit()

        # Simulate Notifications
        num_notifications = randint(50, 100)
        logger.info("Simulating " + str(num_notifications) + " Notifications")
        team_ids = [id[0] for id in db.session.query(Team.id).all()]
        for _ in range(num_notifications):
            notification = Notification(
                message="Test Notification",
                target="/admin/notifications",
            )
            if randint(0, 1) == 1:
                notification.is_read = True
            notification.team_id = choice(team_ids)
            db.session.add(notification)
            db.session.commit()

        # Simulate BTA (Black Team Agent) data
        # Define agent hosts (Windows and Linux targets)
        agent_hosts = [
            ("win-dc", Platform.windows),
            ("win-workstation", Platform.windows),
            ("nix-web", Platform.nix),
            ("nix-db", Platform.nix),
        ]

        # Create AgentCheck services for each blue team
        logger.info("Creating AgentCheck services for BTA")
        blue_teams = Team.get_all_blue_teams()
        for team in blue_teams:
            for host, platform in agent_hosts:
                agent_service = Service(
                    name=f"Agent-{host}",
                    team=team,
                    check_name="AgentCheck",
                    host=host,
                    port=0,
                    points=50,
                )
                db.session.add(agent_service)
        db.session.commit()

        # Get all AgentCheck services for check simulation
        agent_services = db.session.query(Service).filter(Service.check_name == "AgentCheck").all()

        # Add checks for AgentCheck services in existing rounds
        logger.info("Adding checks for AgentCheck services")
        rounds = db.session.query(Round).all()
        for round_obj in rounds:
            for service in agent_services:
                # Randomly decide if agent is up or down (70% up)
                result = randint(0, 10) <= 7
                reason = CHECK_SUCCESS_TEXT if result else CHECK_FAILURE_TEXT
                output = "Agent checked in successfully" if result else "Agent not responding"
                command = "agent_check"
                check = Check(round=round_obj, service=service)
                check.finished(result, reason, output, command)
                db.session.add(check)
        db.session.commit()

        # Simulate Flags with proper timing and hosts
        num_flags = randint(15, 25)
        logger.info("Simulating " + str(num_flags) + " Flags")

        # Get all hosts from agent services for solves
        all_agent_hosts = [host for host, platform in agent_hosts]

        for i in range(num_flags):
            # Spread flags over time - some past, some current, some future
            if i < num_flags // 3:
                # Past flags (ended)
                start_offset = randint(120, 240)
                duration = randint(30, 60)
                start_time = datetime.now() - timedelta(minutes=start_offset)
                end_time = start_time + timedelta(minutes=duration)
            elif i < 2 * num_flags // 3:
                # Current flags (active now)
                start_offset = randint(10, 60)
                start_time = datetime.now() - timedelta(minutes=start_offset)
                end_time = datetime.now() + timedelta(minutes=randint(30, 120))
            else:
                # Future flags (not started yet)
                start_time = datetime.now() + timedelta(minutes=randint(5, 60))
                end_time = start_time + timedelta(minutes=randint(30, 90))

            # Select platform and matching host
            platform = choice([Platform.nix, Platform.windows])
            platform_hosts = [h for h, p in agent_hosts if p == platform]

            flag = Flag(
                start_time=start_time,
                end_time=end_time,
            )
            flag.platform = platform
            flag.dummy = choice([False, False, False, True])  # 25% dummy flags
            flag.type = choice([FlagTypeEnum.file, FlagTypeEnum.pipe, FlagTypeEnum.net, FlagTypeEnum.reg])
            flag.perm = choice([Perm.user, Perm.root])

            # Set appropriate data based on flag type
            if flag.type == FlagTypeEnum.file:
                flag.data = {"path": f"/tmp/flag_{i}.txt" if platform == Platform.nix else f"C:\\temp\\flag_{i}.txt", "content": f"FLAG{i}_{flag.perm.value}"}
            elif flag.type == FlagTypeEnum.reg:
                flag.data = {"path": f"HKLM\\SOFTWARE\\Flag{i}", "content": f"FLAG{i}"}
            elif flag.type == FlagTypeEnum.pipe:
                flag.data = {"path": f"\\\\.\\pipe\\flag_{i}", "content": f"FLAG{i}"}
            else:  # net
                flag.data = {"path": f"tcp://127.0.0.1:{8000 + i}", "content": f"FLAG{i}"}

            db.session.add(flag)
            db.session.commit()

            # Simulate Solves - only for non-dummy, active/past flags
            if not flag.dummy and flag.start_time <= datetime.now():
                # Get blue team IDs
                blue_team_ids = [team.id for team in blue_teams]

                # Random subset of teams solved this flag on random hosts
                num_solves = randint(0, len(blue_team_ids))
                solving_teams = sample(blue_team_ids, num_solves)

                for team_id in solving_teams:
                    # Pick a host matching the flag platform
                    solve_host = choice(platform_hosts)
                    solve = Solve(
                        flag=flag,
                        host=solve_host,
                        team_id=team_id,
                    )
                    db.session.add(solve)
            db.session.commit()

        # Create some Agent tasks (red team agent tasks)
        logger.info("Simulating Agent tasks")
        for platform in [Platform.windows, Platform.nix]:
            for i in range(randint(3, 6)):
                agent = Agent(
                    type=choice([FlagTypeEnum.file, FlagTypeEnum.pipe, FlagTypeEnum.net, FlagTypeEnum.reg]),
                    platform=platform,
                    data={"command": f"task_{platform.value}_{i}", "args": ["--test"]},
                    start_time=datetime.now() - timedelta(minutes=randint(0, 120)),
                    end_time=datetime.now() + timedelta(minutes=randint(30, 180)),
                )
                db.session.add(agent)
        db.session.commit()
