# CPU Affinity Override for Scoring Engine
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.affinity.yml up --scale worker=8
#
# This file pins services to specific CPU cores so that workers
# cannot starve the web UI, database, or cache during a competition.
#
# Default layout assumes 32 cores (0-31):
#
#   Cores 0-3   (4 cores)  -> nginx + web    (serves the scoreboard UI)
#   Cores 4-5   (2 cores)  -> redis + mysql   (database + cache)
#   Core  4     (shared)   -> engine          (lightweight round scheduler)
#   Cores 6-31  (26 cores) -> workers         (service checks, I/O-bound)
#
# Adjust the cpuset values below to match your hardware. The important
# rule: keep workers OFF the cores used by web + nginx.
#
# To verify pinning after startup:
#   docker inspect --format '{{.HostConfig.CpusetCpus}}' <container>
#
---
services:
  nginx:
    cpuset: "0-3"

  web:
    cpuset: "0-3"

  redis:
    cpuset: "4-5"

  mysql:
    cpuset: "4-5"

  engine:
    cpuset: "4-5"

  bootstrap:
    cpuset: "4-5"

  worker:
    cpuset: "6-31"
    environment:
      - SCORINGENGINE_WORKER_NUM_CONCURRENT_TASKS=10
